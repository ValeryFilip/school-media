---
interface ModuleCard {
  lessons: string;
  title: string;
  items: string[];
}
interface Props {
  id?: string; // для уникальных id кнопок/контейнера
  title: string;
  infoHtml: string;
  modules: ModuleCard[];
}

const {
  id = "modules",
  title = "Содержание курса",
  infoHtml = "",
  modules = [],
} = Astro.props as Props;

const SWIPER_ID = `${id}-modules-swiper`;
const SWIPER_PREV = `${id}-swiper-prev`;
const SWIPER_NEXT = `${id}-swiper-next`;
---

<div class="content-block">
  <div class="modules">
    <div class="modules__head">
      <h2 class="modules__h2">{title}</h2>
      <div class="modules__info" set:html={infoHtml} />
    </div>

    <div class="swiper" id={SWIPER_ID} aria-label="Слайдер модулей">
      <div class="swiper-wrapper">
        {
          modules.map((m) => (
            <div class="swiper-slide" aria-label={m.title}>
              <div class="module-tag">{m.lessons}</div>
              <div class="module-title">{m.title}</div>
              <ul class="module-list">
                {m.items.map((it) => (
                  <li>{it}</li>
                ))}
              </ul>
            </div>
          ))
        }
      </div>

      <!-- Кнопки внутри контейнера, справа-снизу с отступом 20px -->
      <div class="swiper-controls" aria-label="Управление слайдером">
        <button
          id={SWIPER_PREV}
          class="swiper-button-prev"
          type="button"
          aria-label="Назад"></button>
        <button
          id={SWIPER_NEXT}
          class="swiper-button-next"
          type="button"
          aria-label="Вперёд"></button>
      </div>
    </div>
  </div>

  <style>
    .content-block {
      width: 1200px;
      max-width: 95%;
      margin: 0 auto;
      background: none;
    }

    .modules__head {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      margin: 0 0 20px;
    }
    .modules__h2 {
      font-weight: 700;
      font-size: var(--h2);
      line-height: 1.2;
      color: #fff;
      margin: 0;
    }
    .modules__info {
      text-align: right;
      font-size: 25px;
      color: #fff;
    }

    .swiper {
      position: relative;
      width: 100%;
      height: 370px;
      overflow: hidden;
      padding-bottom: 72px;
    } /* место под кнопки */
    .swiper-wrapper {
      display: flex;
      will-change: transform;
      transition: transform 0.3s ease;
    }
    .swiper-slide {
      flex: 0 0 calc(50% - 15px);
      margin-right: 30px;
      background: #fff;
      border-radius: 24px;
      padding: 28px 24px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 10px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-1);
    }
    .swiper-slide:last-child {
      margin-right: 0;
    }

    .module-tag {
      font-weight: 700;
      font-size: 18px;
      line-height: 1;
      color: var(--blue);
      margin-bottom: 8px;
    }
    .module-title {
      font-weight: 700;
      font-size: 20px;
      line-height: 1.3;
      color: #191c21;
      margin: 0 0 8px;
    }
    .module-list {
      list-style: disc;
      padding-left: 18px;
      margin: 0;
      font-weight: 500;
      font-size: 16px;
      line-height: 1.5;
      color: #222;
    }

    .swiper-controls {
      position: absolute;
      right: 20px;
      bottom: 20px;
      display: flex;
      gap: 10px;
      z-index: 2;
    }
    .swiper-button-next,
    .swiper-button-prev {
      inline-size: 40px;
      block-size: 40px;
      border-radius: 50%;
      border: 0;
      cursor: pointer;
      background: #e2e8f0;
      display: grid;
      place-items: center;
      transition:
        background-color 0.2s ease,
        opacity 0.2s ease;
    }
    .swiper-button-next:hover,
    .swiper-button-prev:hover {
      background: #cbd5e1;
    }
    .swiper-button-next::after,
    .swiper-button-prev::after {
      content: "";
      width: 10px;
      height: 10px;
      display: block;
      border-top: 2.5px solid #222;
      border-right: 2.5px solid #222;
    }
    .swiper-button-next::after {
      transform: rotate(45deg);
    }
    .swiper-button-prev::after {
      transform: rotate(-135deg);
    }
    .swiper-button-disabled {
      opacity: 0.45;
      pointer-events: none;
    }

    @media (max-width: 1100px) {
      .modules__h2 {
        font-size: 28px;
        padding: 0 var(--pad-desktop);
      }
      .modules__info {
        font-size: 22px;
        padding: 0 var(--pad-desktop);
        text-align: left;
      }
      .swiper {
        padding: 0 var(--pad-desktop);
        padding-bottom: 72px;
        height: auto;
      }
      .swiper-wrapper {
        gap: 20px;
      }
      .swiper-slide {
        flex: 0 0 calc(100% - 20px);
        height: auto;
        margin-right: 0;
      }
      .swiper-controls {
        right: var(--pad-desktop);
        bottom: 20px;
      }
    }
    @media (max-width: 600px) {
      .modules__h2 {
        font-size: 24px;
        padding: 0 var(--pad-mobile);
      }
      .modules__info {
        padding: 0 var(--pad-mobile);
      }
      .swiper {
        padding: 0 var(--pad-mobile);
        padding-bottom: 72px;
      }
      .swiper-controls {
        right: var(--pad-mobile);
        bottom: 20px;
      }
    }
  </style>

  <script is:inline>
    (function () {
      const container = document.getElementById("${SWIPER_ID}");
      if (!container) return;
      const wrapper = container.querySelector(".swiper-wrapper");
      const slides = Array.from(wrapper ? wrapper.children : []);
      const prevBtn = container.querySelector("#${SWIPER_PREV}");
      const nextBtn = container.querySelector("#${SWIPER_NEXT}");
      if (!wrapper || slides.length === 0 || !prevBtn || !nextBtn) return;

      let index = 0;
      let perView = 2;
      let stepPx = 0;

      // шаг = разница offsetLeft между 1-м и 2-м слайдами (устойчиво к gap/margin)
      function computeStep() {
        if (slides.length > 1) {
          stepPx = Math.max(1, slides[1].offsetLeft - slides[0].offsetLeft);
        } else {
          stepPx = Math.max(1, slides[0].getBoundingClientRect().width);
        }
      }
      function computePerView() {
        perView = window.matchMedia("(max-width: 1100px)").matches ? 1 : 2;
      }
      function maxIndex() {
        return Math.max(0, slides.length - perView);
      }
      function clamp(v, min, max) {
        return Math.max(min, Math.min(max, v));
      }

      function apply() {
        const maxI = maxIndex();
        index = clamp(index, 0, maxI);
        wrapper.style.transform = `translateX(${-index * stepPx}px)`;
        prevBtn.classList.toggle("swiper-button-disabled", index === 0);
        nextBtn.classList.toggle("swiper-button-disabled", index === maxI);
      }

      nextBtn.addEventListener("click", () => {
        index++;
        apply();
      });
      prevBtn.addEventListener("click", () => {
        index--;
        apply();
      });
      window.addEventListener("resize", () => {
        computePerView();
        computeStep();
        apply();
      });
      window.addEventListener("load", () => {
        computePerView();
        computeStep();
        apply();
      });

      computePerView();
      computeStep();
      apply();
    })();
  </script>
</div>
