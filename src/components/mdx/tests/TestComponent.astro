---
interface Question {
  type: "radio" | "checkbox" | "text";
  mode?: "alone" | "slider";
  title?: string;
  text: string;
  items?: {
    text: string;
    correct: boolean;
  }[];
  correctTextAnswer?: string;
  helpText: string;
  explanationText: string;
}

interface Props {
  questions: Question[];
}

const questionId = `q-${Math.random().toString(36).slice(2, 8)}`;
const { questions } = Astro.props;
---

<div
  class={`section test-section`}
  data-type={questions[0].type}
  data-correcttext={questions[0].correctTextAnswer}
  data-mode={questions[0].mode ?? "alone"}
>
  <div class="test__wrapper">
    <div class="test__content">
      <div class="test__question">
        <p class="test__question-text">
          {questions[0].text}
        </p>
        {
          questions[0].type !== "text" && (
            <div class="test__question-items">
              {questions[0].items &&
                questions[0].items.map((item, i) => (
                  <div class="test__question-item">
                    <input
                      class="test__question-input"
                      type={
                        questions[0].type === "radio" ? "radio" : "checkbox"
                      }
                      name={questionId}
                      id={`${questionId}-${i}`}
                      data-correct={String(item.correct)}
                    />
                    <label for={`${questionId}-${i}`}>{item.text}</label>
                  </div>
                ))}
            </div>
          )
        }
        {
          questions[0].type === "text" && (
            <div class="test__question-text-input">
              <input
                class="test__text-input"
                type="text"
                placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç"
                name={questionId}
                id={questionId}
              />
            </div>
          )
        }

        <div class="test__answer-buttons">
          <button class="test__answer-button-text">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
          <button class="test__next-button" data-next hidden>–î–∞–ª–µ–µ</button>
        </div>
      </div>
      <div class="test__answer-result" hidden>
        <p class="test__answer-result-text">–û—Ç–≤–µ—Ç</p>
      </div>
      <div class="test__answer-text" hidden>
        <p class="test__answer-explanation">
          {questions[0].explanationText}
        </p>
        <p class="test__answer-hint">
          {questions[0].helpText}
        </p>
      </div>
    </div>
  </div>
</div>

<style>
  .test-section {
    max-width: 100%;
    margin: 0 auto;
  }

  .test__wrapper {
    background: var(--white);
    border-radius: clamp(8px, 1.2vw, 12px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    border: 2px solid var(--border);
    padding: clamp(24px, 3vw, 32px);
  }
  .test__wrapper:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  }

  .test__content {
    display: flex;
    flex-direction: column;
    gap: clamp(16px, 2vw, 20px);
  }

  .test__question {
    display: flex;
    flex-direction: column;
    gap: clamp(16px, 2vw, 20px);
  }

  .test__question-text {
    font-size: clamp(16px, 1.8vw, 18px);
    font-weight: 600;
    color: var(--black);
    margin: 0;
    line-height: 1.5;
  }

  .test__question-items {
    display: flex;
    flex-direction: column;
    gap: clamp(10px, 1.2vw, 12px);
  }

  .test__question-item {
    display: flex;
    align-items: center;
    gap: clamp(10px, 1.2vw, 12px);
    padding: clamp(12px, 1.6vw, 16px) clamp(16px, 2vw, 20px);
    background: #f9f9f9;
    border: 1px solid var(--border);
    border-radius: clamp(6px, 0.8vw, 8px);
    transition: all 0.2s ease;
    cursor: pointer;
  }

  .test__question-item:hover {
    background: #f0f7ff;
    border-color: #b3d9ff;
  }

  .test__question-item:has(input:checked) {
    background: #e6f2ff;
    border-color: var(--blue);
  }

  .test__question-input {
    width: clamp(18px, 2vw, 20px);
    height: clamp(18px, 2vw, 20px);
    cursor: pointer;
    accent-color: var(--blue);
    flex-shrink: 0;
  }

  .test__question-item label {
    font-size: clamp(14px, 1.5vw, 16px);
    color: var(--gray);
    cursor: pointer;
    flex: 1;
    line-height: 1.5;
    user-select: none;
  }

  .test__question-text-input {
    margin-top: clamp(8px, 1vw, 12px);
  }

  .test__text-input {
    width: 100%;
    padding: clamp(12px, 1.6vw, 16px) clamp(16px, 2vw, 20px);
    font-size: clamp(14px, 1.5vw, 16px);
    color: var(--gray);
    background: #f9f9f9;
    border: 1px solid var(--border);
    border-radius: clamp(6px, 0.8vw, 8px);
    transition: all 0.2s ease;
    outline: none;
    box-sizing: border-box;
  }

  .test__text-input::placeholder {
    color: var(--gray);
  }

  .test__text-input:hover {
    background: #f0f7ff;
    border-color: #b3d9ff;
  }

  .test__text-input:focus {
    background: var(--white);
    border-color: var(--blue);
    box-shadow: 0 0 0 3px rgba(54, 110, 240, 0.1);
  }

  .test__answer-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: clamp(10px, 1.2vw, 12px);
    margin-top: clamp(8px, 1vw, 12px);
  }

  .test__answer-button-text,
  .test__next-button {
    background: var(--blue);
    color: var(--white);
    border: none;
    border-radius: clamp(6px, 0.8vw, 8px);
    padding: clamp(12px, 1.6vw, 16px) clamp(24px, 3vw, 32px);
    font-size: clamp(14px, 1.6vw, 16px);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .test__answer-button-text:hover,
  .test__next-button:hover {
    background: #2a5dd9;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(54, 110, 240, 0.3);
  }

  .test__answer-button-text:active,
  .test__next-button:active {
    transform: translateY(0);
  }

  .test__answer-result {
    padding: clamp(12px, 1.6vw, 16px) clamp(16px, 2vw, 20px);
    border-radius: clamp(6px, 0.8vw, 8px);
    background: var(--white);
    border-left: 4px solid var(--blue);
  }

  .test__answer-result-text {
    font-size: clamp(14px, 1.6vw, 16px);
    font-weight: 600;
    color: var(--black);
    margin: 0;
  }

  .test__answer-text {
    padding: clamp(12px, 1.6vw, 16px) clamp(16px, 2vw, 20px);
    border-radius: clamp(6px, 0.8vw, 8px);
    background: #e6f2ff;
    border-left: 4px solid var(--blue);
  }

  .test__answer-explanation,
  .test__answer-hint {
    font-size: clamp(14px, 1.5vw, 15px);
    color: var(--gray);
    line-height: 1.6;
    margin: 0;
  }

  /* –°—Ç–∏–ª–∏ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ */
  .test__answer-result[data-result="correct"] {
    background: #e6f9f8;
    border-left-color: var(--green);
  }

  .test__answer-result[data-result="correct"] .test__answer-result-text {
    color: var(--green);
  }

  /* –°—Ç–∏–ª–∏ –¥–ª—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ */
  .test__answer-result[data-result="incorrect"] {
    background: #ffe6e9;
    border-left-color: var(--error);
  }

  .test__answer-result[data-result="incorrect"] .test__answer-result-text {
    color: var(--error);
  }

  @media (max-width: 600px) {
    .test__wrapper {
      padding: 20px;
    }

    .test__question-item {
      padding: 12px 16px;
    }

    .test__text-input {
      padding: 12px 16px;
      font-size: 14px;
    }
  }
</style>

<script is:inline>
  document.querySelectorAll(".test-section").forEach((test) => {
    const questionInputs = test.querySelectorAll(".test__question-input");
    const answerButton = test.querySelector(".test__answer-button-text");
    const nextButton = test.querySelector(".test__next-button");
    const resultContainer = test.querySelector(".test__answer-result");
    const resultText = test.querySelector(".test__answer-result-text");
    const helpContainer = test.querySelector(".test__answer-text");
    const explanationText = test.querySelector(".test__answer-explanation");
    const hintText = test.querySelector(".test__answer-hint");
    const textInput = test.querySelector(".test__text-input");

    function resetUI() {
      resultContainer.hidden = true;
      helpContainer.hidden = true;
      explanationText.hidden = true;
      hintText.hidden = true;
      resultContainer.removeAttribute("data-result");
      if (test.dataset.mode === "slider") {
        nextButton.hidden = true;
      }
    }

    function showEmpty() {
      resultContainer.hidden = false;
      resultText.textContent = "–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –æ—Ç–≤–µ—Ç";
      helpContainer.hidden = true;
    }

    function showCorrect() {
      resultContainer.hidden = false;
      resultContainer.dataset.result = "correct";
      resultText.textContent = "–í—ã –æ—Ç–≤–µ—Ç–∏–ª–∏ –≤–µ—Ä–Ω–æ";

      helpContainer.hidden = false;
      explanationText.hidden = false;
      hintText.hidden = true;

      if (test.dataset.mode === "slider") {
        nextButton.hidden = false;
      }

      // üîî –°–û–û–ë–©–ê–ï–ú –ù–ê–†–£–ñ–£
      // test.dispatchEvent(
      //   new CustomEvent("test:correct", {
      //     bubbles: true,
      //     detail: {
      //       type: test.dataset.type,
      //     },
      //   })
      // );
    }

    function showIncorrect() {
      resultContainer.hidden = false;
      resultContainer.dataset.result = "incorrect";
      resultText.textContent = "–í—ã –æ—Ç–≤–µ—Ç–∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω–æ";

      helpContainer.hidden = false;
      explanationText.hidden = true;
      hintText.hidden = false;

      if (test.dataset.mode === "slider") {
        nextButton.hidden = true;
      }
    }

    answerButton.addEventListener("click", () => {
      resetUI();
      const questionType = test.dataset.type;

      // ===== TEXT =====
      if (questionType === "text") {
        const writtenAnswer = textInput?.value.trim();

        if (!writtenAnswer) {
          showEmpty();
          if (test.dataset.mode === "slider") {
            nextButton.hidden = true;
          }
          return;
        }

        const correctAnswer = test.dataset.correcttext?.trim();

        if (!correctAnswer) {
          showIncorrect();
          return;
        }

        if (writtenAnswer.toLowerCase() === correctAnswer.toLowerCase()) {
          showCorrect();
        } else {
          showIncorrect();
        }

        return;
      }

      const checkedInputs = Array.from(questionInputs).filter(
        (input) => input.checked
      );
      const correctAnswers = Array.from(questionInputs).filter(
        (input) => input.dataset.correct == "true"
      );

      if (checkedInputs.length === 0) {
        showEmpty();
        return;
      }
      if (questionType === "checkbox") {
        if (checkedInputs.length !== correctAnswers.length) {
          showIncorrect();
          return;
        }

        for (let i = 0; i < correctAnswers.length; i++) {
          if (!checkedInputs.includes(correctAnswers[i])) {
            showIncorrect();
            return;
          }
        }

        showCorrect();
      }
      if (questionType === "radio") {
        checkedInputs[0].dataset.correct === "true"
          ? showCorrect()
          : showIncorrect();
      }
    });

    // –ö–Ω–æ–ø–∫–∞ ¬´–î–∞–ª–µ–µ¬ª ‚Äî –≤–µ—à–∞–µ–º –æ–¥–∏–Ω —Ä–∞–∑, –∏–Ω–∞—á–µ –¥–ª—è type="text" –Ω–µ –¥–æ—Ö–æ–¥–∏–ª–æ (return –¥–æ –±–ª–æ–∫–∞)
    nextButton?.addEventListener("click", () => {
      test.dispatchEvent(
        new CustomEvent("test:next", {
          bubbles: true,
        })
      );
    });
  });
</script>
