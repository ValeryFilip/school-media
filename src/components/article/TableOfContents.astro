---
/**
 * TableOfContents - Оглавление статьи
 * Генерирует список заголовков H2 и H3 из контента
 */
interface TocItem {
  id: string;
  text: string;
  depth?: number;
}

interface Props {
  items?: TocItem[];
  levels?: string; // например "h2,h3"
  articlePath?: string; // путь к статье, например "/academy/category-slug/slug"
}

const { items = [], levels = "h2,h3", articlePath } = Astro.props;

// Строим вложенную структуру
function buildNestedToc(items: TocItem[]) {
  const result: any[] = [];
  let currentH2: any = null;

  items.forEach((item) => {
    if (item.depth === 2) {
      currentH2 = { ...item, children: [] };
      result.push(currentH2);
    } else if (item.depth === 3 && currentH2) {
      currentH2.children.push(item);
    }
  });

  return result;
}

const nestedItems = buildNestedToc(items);
---

<aside
  class="toc"
  data-toc-levels={levels}
  data-article-path={articlePath || ""}
>
  <h2 class="toc__title">Содержание</h2>
  <ul id="tocList" class="toc__list">
    {
      nestedItems.map((item) => (
        <li class="toc__item">
          <a href={`${articlePath || ""}#${item.id}`} class="toc__link">
            {item.text}
          </a>
          {item.children && item.children.length > 0 && (
            <ul class="toc__sublist">
              {item.children.map((child: TocItem) => (
                <li class="toc__subitem">
                  <a
                    href={`${articlePath || ""}#${child.id}`}
                    class="toc__link"
                  >
                    {child.text}
                  </a>
                </li>
              ))}
            </ul>
          )}
        </li>
      ))
    }
  </ul>
</aside>

<style>
  .toc {
    background: var(--white);
    border-radius: 8px;
    padding: 1.5rem;
    margin: 2rem 0;
  }
  .toc__title {
    font-size: 1.2rem;
    font-weight: 600;
    margin: 0 0 1rem;
  }
  .toc__list {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  .toc__item {
    margin: 0.5rem 0;
  }
  .toc__sublist {
    list-style: none;
    padding: 0;
    margin: 0.5rem 0 0 1.5rem;
  }
  .toc__subitem {
    margin: 0.35rem 0;
  }
  .toc__link {
    color: var(--blue);
    text-decoration: none;
    transition: color 0.2s ease;
  }
  .toc__link:hover {
    color: var(--blue);
    text-decoration: underline;
  }
</style>

<script>
  // TOC: якоря к текущему пути
  (function () {
    const content = document.querySelector(".content");
    const list = document.getElementById("tocList");
    const tocBox = document.querySelector(".toc");
    if (!content || !list || !tocBox) return;
    if (list.children.length > 0) return;

    const levels = (tocBox.getAttribute("data-toc-levels") || "h2,h3")
      .split(",")
      .map((s) => s.trim().toUpperCase())
      .filter(Boolean);

    const articlePath =
      tocBox.getAttribute("data-article-path") || window.location.pathname;
    const basePath = articlePath || window.location.pathname;

    const heads = content.querySelectorAll(levels.join(","));
    let currentH2Li: HTMLLIElement | null = null;
    let currentSublist: HTMLUListElement | null = null;

    heads.forEach((h) => {
      if (!h.id) {
        h.id = (h.textContent || "")
          .trim()
          .toLowerCase()
          .replace(/[^\p{L}\p{N}\s-]/gu, "")
          .replace(/\s+/g, "-");
      }

      if (h.tagName === "H2") {
        // Создаем элемент для H2
        const li = document.createElement("li");
        li.className = "toc__item";
        const a = document.createElement("a");
        a.className = "toc__link";
        a.href = basePath + "#" + h.id;
        a.textContent = h.textContent || "";
        li.appendChild(a);
        list.appendChild(li);

        // Запоминаем текущий H2 для вложенных H3
        currentH2Li = li;
        currentSublist = null;
      } else if (h.tagName === "H3" && currentH2Li) {
        // Создаем подсписок для H3, если его еще нет
        if (!currentSublist) {
          currentSublist = document.createElement("ul");
          currentSublist.className = "toc__sublist";
          currentH2Li.appendChild(currentSublist);
        }

        // Создаем элемент для H3
        const li = document.createElement("li");
        li.className = "toc__subitem";
        const a = document.createElement("a");
        a.className = "toc__link";
        a.href = basePath + "#" + h.id;
        a.textContent = h.textContent || "";
        li.appendChild(a);
        currentSublist.appendChild(li);
      }
    });
  })();
</script>
