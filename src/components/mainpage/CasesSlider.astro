---
/* src/components/CasesSlider.astro */
---

<section class="section cases-slider" aria-labelledby="cases-title">
  <style>
    /* Геометрия / расположение. Цвета/шрифты — из глобалки */
    .cases-slider {
      --nav-size: 48px; /* диаметр кнопки */
      --nav-gap: 24px; /* от окна до кнопки */
      --nav-gutter: calc(
        var(--nav-size) + var(--nav-gap)
      ); /* внутренние поля окна под стрелки */
      --child-overhang: 120px; /* «свес» нижних мини-картинок */
      --child-space: -120px; /* перекрытие мини-картинок */
      --card-scale: 1; /* меняет JS при 1 карточке */

      position: relative;
      font-family: var(--ff);
      color: var(--black);
    }

    /* Заголовок внутри контейнера — типографика берётся из глобального h2/.h2 (== 42 на десктопе) */
    .cases-header .h2,
    .cases-header h2 {
      margin: 0 0 var(--space-16);
    }

    /* Окно и трек */
    .cases-viewport {
      position: relative;
      max-width: var(--container);
      margin: 0 auto;
      padding: 0 var(--pad-desktop);
      /* поле под стрелки, чтобы контент не залезал под них */
      box-sizing: content-box;
    }
    @media (max-width: 1100px) {
      .cases-viewport {
        width: 100vw;
        margin-inline: calc(50% - 50vw);
        max-width: none;
      }
      @supports (width: 100dvw) {
        .cases-viewport {
          width: 100dvw;
          margin-inline: calc(50% - 50dvw);
        }
      }
    }
    .cases-viewport-inner {
      overflow: hidden;
      margin: 0 var(--nav-gutter);
    }
    .cases-track {
      display: flex;
      gap: 70px; /* JS поставит 0 при одной карточке */
      will-change: transform;
      transition: transform 0.35s var(--easing);
      list-style: none;
      margin: 0;
      padding: 0;
    }

    /* Слайд: высота = высоте карточки + «свесу» */
    .cases-slide {
      flex: 0 0 auto;
      position: relative;
      min-height: calc((480px + var(--child-overhang)) * var(--card-scale));
    }

    /* Кнопки навигации — выровнены по краям контейнера */
    .cases-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: var(--nav-size);
      height: var(--nav-size);
      border-radius: 50%;
      border: 1px solid var(--border);
      background: #fff;
      box-shadow: var(--shadow-1);
      display: grid;
      place-items: center;
      cursor: pointer;
      z-index: 3;
    }
    .cases-nav.prev {
      left: var(--pad-desktop);
    }
    .cases-nav.next {
      right: var(--pad-desktop);
    }
    .cases-nav::before {
      content: "";
      width: 12px;
      height: 12px;
      border-top: 2px solid var(--blue);
      border-right: 2px solid var(--blue);
      transform: rotate(45deg);
    }
    .cases-nav.prev::before {
      transform: rotate(-135deg);
    }
    .cases-nav[disabled] {
      opacity: 0.45;
      pointer-events: none;
    }

    /* Карточка кейса — центр + масштаб из JS */
    .case-card {
      width: 550px;
      height: 480px;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: var(--radius-24);
      box-shadow: var(--shadow-1);
      padding: var(--space-24);
      box-sizing: border-box;
      display: flex;
      flex-direction: column;

      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%) scale(var(--card-scale));
      transform-origin: top center;
      overflow: visible;
    }

    .case-top {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      column-gap: 24px;
      margin-bottom: 16px;
    }
    .case-label {
      font-size: 16px;
      font-weight: 400;
      text-align: center;
      margin: 0 0 8px;
    }
    .circle-score {
      width: 130px;
      height: 130px;
      border: 2px solid #cfcfcf;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto;
    }
    .circle-score strong {
      font-size: 60px;
      font-weight: 500;
      line-height: 1;
    }
    .arrow-tris {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .arrow-tris .tri {
      width: 0;
      height: 0;
      border-top: 10px solid transparent;
      border-bottom: 10px solid transparent;
      border-left: 18px solid #a7a7a7;
    }

    .uni {
      font-size: 16px;
      font-weight: 400;
      margin: 8px 0;
    }
    .divider {
      height: 1px;
      background: #cfcfcf;
      margin-bottom: 12px;
    }

    /* Автор */
    .case-card .author {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 12px;
    }
    .case-card figure.avatar {
      margin: 0;
      flex: 0 0 50px;
    }
    .case-card .avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      overflow: hidden;
      background: #e9e9e9;
      border: 1px solid var(--border);
    }
    .case-card .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .case-card .author-info {
      margin-left: 0;
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
    }
    .case-card .author-name {
      font-size: 16px;
      font-weight: 700;
      margin: 0 0 4px 0;
    }
    .case-card .tg-line {
      display: flex;
      align-items: center;
      gap: 6px;
      margin: 0 0 8px 0;
    }
    .case-card .tg-line img {
      width: 14px;
      height: 14px;
    }
    .case-card .tg-handle {
      font-size: 12px;
      font-weight: 400;
      color: #6f6f6f;
    }
    .case-card .review {
      font-size: 12px;
      font-weight: 400;
      line-height: 1.5;
      margin: 0;
    }

    /* Нижние мини-карточки */
    .child-cards {
      position: absolute;
      left: 0;
      right: 0;
      bottom: calc(-1 * var(--child-overhang));
      display: flex;
      justify-content: center;
      z-index: 5;
      pointer-events: auto;
    }
    .child {
      width: 300px;
      height: 170px;
      box-sizing: border-box;
      flex-shrink: 0;
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow-1);
      overflow: hidden;
      background: #fff;
      cursor: pointer;
      transition:
        transform 0.25s var(--easing),
        box-shadow 0.25s var(--easing);
    }
    .child + .child {
      margin-left: var(--child-space);
    }
    .child img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .child.left {
      transform: rotate(-6deg);
      z-index: 1;
    }
    .child.right {
      transform: rotate(8deg);
      z-index: 2;
    }
    .child:hover {
      transform: translateY(-6px) scale(1.02);
      box-shadow: var(--shadow-2);
    }

    /* Попап */
    .popup-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .popup-overlay.active {
      display: flex;
    }
    .popup-content {
      position: relative;
      background: #fff;
      padding: 10px;
      border-radius: 14px;
      max-width: 90vw;
      max-height: 90vh;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
    }
    .popup-content img {
      width: 100%;
      height: auto;
      display: block;
      border-radius: 10px;
    }
    .popup-close {
      position: absolute;
      top: -12px;
      right: -12px;
      width: 34px;
      height: 34px;
      border-radius: 50%;
      border: 1px solid var(--border);
      background: #fff;
      box-shadow: var(--shadow-1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: 700;
      cursor: pointer;
    }

    /* Адаптив */
    @media (max-width: 1100px) {
      .cases-viewport {
        padding: 0 var(--pad-mobile);
      }
      .cases-viewport-inner {
        margin: 0;
      } /* стрелки станут поверх, без внутренних полей */
      .cases-nav {
        width: 44px;
        height: 44px;
      }
      .cases-nav.prev {
        left: var(--pad-mobile);
      }
      .cases-nav.next {
        right: var(--pad-mobile);
      }
    }
    @media (max-width: 600px) {
      .cases-nav {
        width: 40px;
        height: 40px;
      }
      .cases-nav.prev {
        left: var(--pad-mobile);
      }
      .cases-nav.next {
        right: var(--pad-mobile);
      }
    }
  </style>

  <div class="container">
    <div class="cases-header">
      <h2 id="cases-title" class="h2">Кейсы наших учеников</h2>
    </div>
  </div>

  <!-- Стрелки позиционируются относительно секции, но выровнены по паддингам контейнера -->
  <button class="cases-nav prev" type="button" aria-label="Предыдущие кейсы"
  ></button>

  <div
    class="cases-viewport"
    role="region"
    aria-roledescription="карусель"
    aria-labelledby="cases-title"
  >
    <div class="cases-viewport-inner">
      <ul class="cases-track">
        <!-- слайды — твои без изменений -->
        <li class="cases-slide">
          <article class="case-card">
            <div class="case-top">
              <div>
                <p class="case-label">входной пробник</p><div
                  class="circle-score"
                >
                  <strong>12</strong>
                </div>
              </div>
              <div class="arrow-tris" aria-hidden="true">
                <span class="tri"></span><span class="tri"></span><span
                  class="tri"></span>
              </div>
              <div>
                <p class="case-label">результат на ЕГЭ</p><div
                  class="circle-score"
                >
                  <strong>99</strong>
                </div>
              </div>
            </div>
            <p class="uni">Нижегородский Мед. Университет (бюджет)</p>
            <div class="divider"></div>
            <div class="author">
              <figure class="avatar">
                <img
                  loading="lazy"
                  src="https://images.unsplash.com/photo-1544723795-3fb6469f5b39?w=240&q=80&auto=format&fit=crop"
                  alt=""
                />
              </figure>
              <div class="author-info">
                <p class="author-name">Максим Иванов</p>
                <p class="tg-line">
                  <img
                    src="https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg"
                    alt=""
                  /><span class="tg-handle">@maxttn</span>
                </p>
                <p class="review">
                  “Входной пробник был низким, но за курс подтянул теорию и
                  задачи. На финальном пробнике держал высокий результат, а на
                  ЕГЭ получил 99.”
                </p>
              </div>
            </div>
            <div class="child-cards">
              <figure class="child left">
                <img
                  src="https://images.unsplash.com/photo-1524995997946-a1c2e315a42f?w=900&q=80&auto=format&fit=crop"
                  alt=""
                />
              </figure>
              <figure class="child right">
                <img
                  src="https://images.unsplash.com/photo-1519389950473-47ba0277781c?w=900&q=80&auto=format&fit=crop"
                  alt=""
                />
              </figure>
            </div>
          </article>
        </li>

        <!-- … остальные твои <li class="cases-slide"> как были … -->
        <li class="cases-slide">
          <article class="case-card">
            <div class="case-top">
              <div>
                <p class="case-label">входной пробник</p><div
                  class="circle-score"
                >
                  <strong>18</strong>
                </div>
              </div><div class="arrow-tris" aria-hidden="true">
                <span class="tri"></span><span class="tri"></span><span
                  class="tri"></span>
              </div><div>
                <p class="case-label">результат на ЕГЭ</p><div
                  class="circle-score"
                >
                  <strong>92</strong>
                </div>
              </div>
            </div><p class="uni">СПбГУ (бюджет)</p><div class="divider">
            </div><div class="author">
              <figure class="avatar">
                <img
                  loading="lazy"
                  src="https://images.unsplash.com/photo-1494790108377-be9c29b29330?w=240&q=80&auto=format&fit=crop"
                  alt=""
                />
              </figure><div class="author-info">
                <p class="author-name">Алина Сергеева</p><p class="tg-line">
                  <img
                    src="https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg"
                    alt=""
                  /><span class="tg-handle">@alinase</span>
                </p><p class="review">
                  “Самый понятный разбор задач. Итог — 92.”
                </p>
              </div>
            </div><div class="child-cards">
              <figure class="child left">
                <img
                  src="https://images.unsplash.com/photo-1521587760476-6c12a4b040da?w=900&q=80&auto=format&fit=crop"
                  alt=""
                />
              </figure><figure class="child right">
                <img
                  src="https://images.unsplash.com/photo-1484417894907-623942c8ee29?w=900&q=80&auto=format&fit=crop"
                  alt=""
                />
              </figure>
            </div>
          </article>
        </li>
        <li class="cases-slide">
          <article class="case-card">
            <div class="case-top">
              <div>
                <p class="case-label">входной пробник</p><div
                  class="circle-score"
                >
                  <strong>22</strong>
                </div>
              </div><div class="arrow-tris" aria-hidden="true">
                <span class="tri"></span><span class="tri"></span><span
                  class="tri"></span>
              </div><div>
                <p class="case-label">результат на ЕГЭ</p><div
                  class="circle-score"
                >
                  <strong>95</strong>
                </div>
              </div>
            </div><p class="uni">МГУ (договор)</p><div class="divider">
            </div><div class="author">
              <figure class="avatar">
                <img
                  loading="lazy"
                  src="https://images.unsplash.com/photo-1527980965255-d3d416303d12?w=240&q=80&auto=format&fit=crop"
                  alt=""
                />
              </figure><div class="author-info">
                <p class="author-name">Влад Жуков</p><p class="tg-line">
                  <img
                    src="https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg"
                    alt=""
                  /><span class="tg-handle">@vladz</span>
                </p><p class="review">“Системный план и ОВР вывели на 95.”</p>
              </div>
            </div><div class="child-cards">
              <figure class="child left">
                <img
                  src="https://images.unsplash.com/photo-1496307042754-b4aa456c4a2d?w=900&q=80&auto=format&fit=crop"
                  alt=""
                />
              </figure><figure class="child right">
                <img
                  src="https://images.unsplash.com/photo-1521737604893-d14cc237f11d?w=900&q=80&auto=format&fit=crop"
                  alt=""
                />
              </figure>
            </div>
          </article>
        </li>
        <li class="cases-slide">
          <article class="case-card">
            <div class="case-top">
              <div>
                <p class="case-label">входной пробник</p><div
                  class="circle-score"
                >
                  <strong>10</strong>
                </div>
              </div><div class="arrow-tris" aria-hidden="true">
                <span class="tri"></span><span class="tri"></span><span
                  class="tri"></span>
              </div><div>
                <p class="case-label">результат на ЕГЭ</p><div
                  class="circle-score"
                >
                  <strong>90</strong>
                </div>
              </div>
            </div><p class="uni">НГУ (бюджет)</p><div class="divider"></div><div
              class="author"
            >
              <figure class="avatar">
                <img
                  loading="lazy"
                  src="https://images.unsplash.com/photo-1517841905240-472988babdf9?w=240&q=80&auto=format&fit=crop"
                  alt=""
                />
              </figure><div class="author-info">
                <p class="author-name">Мария Лебедева</p><p class="tg-line">
                  <img
                    src="https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg"
                    alt=""
                  /><span class="tg-handle">@mlebedev</span>
                </p><p class="review">“Много практики, чёткие конспекты.”</p>
              </div>
            </div><div class="child-cards">
              <figure class="child left">
                <img
                  src="https://images.unsplash.com/photo-1492724441997-5dc865305da7?w=900&q=80&auto=format&fit=crop"
                  alt=""
                />
              </figure><figure class="child right">
                <img
                  src="https://images.unsplash.com/photo-1517433456452-f9633a875f6f?w=900&q=80&auto=format&fit=crop"
                  alt=""
                />
              </figure>
            </div>
          </article>
        </li>
        <li class="cases-slide">
          <article class="case-card">
            <div class="case-top">
              <div>
                <p class="case-label">входной пробник</p><div
                  class="circle-score"
                >
                  <strong>20</strong>
                </div>
              </div><div class="arrow-tris" aria-hidden="true">
                <span class="tri"></span><span class="tri"></span><span
                  class="tri"></span>
              </div><div>
                <p class="case-label">результат на ЕГЭ</p><div
                  class="circle-score"
                >
                  <strong>93</strong>
                </div>
              </div>
            </div><p class="uni">НИТУ МИСИС</p><div class="divider"></div><div
              class="author"
            >
              <figure class="avatar">
                <img
                  loading="lazy"
                  src="https://images.unsplash.com/photo-1508214751196-bcfd4ca60f91?w=240&q=80&auto=format&fit=crop"
                  alt=""
                />
              </figure><div class="author-info">
                <p class="author-name">Никита Орлов</p><p class="tg-line">
                  <img
                    src="https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg"
                    alt=""
                  /><span class="tg-handle">@orlov</span>
                </p><p class="review">
                  “Разобрался с расчётными задачами — это решило исход.”
                </p>
              </div>
            </div><div class="child-cards">
              <figure class="child left">
                <img
                  src="https://images.unsplash.com/photo-1484807352052-23338990c6c6?w=900&q=80&auto=format&fit=crop"
                  alt=""
                />
              </figure><figure class="child right">
                <img
                  src="https://images.unsplash.com/photo-1515378791036-0648a3ef77b2?w=900&q=80&auto=format&fit=crop"
                  alt=""
                />
              </figure>
            </div>
          </article>
        </li>
        <li class="cases-slide">
          <article class="case-card">
            <div class="case-top">
              <div>
                <p class="case-label">входной пробник</p><div
                  class="circle-score"
                >
                  <strong>25</strong>
                </div>
              </div><div class="arrow-tris" aria-hidden="true">
                <span class="tri"></span><span class="tri"></span><span
                  class="tri"></span>
              </div><div>
                <p class="case-label">результат на ЕГЭ</p><div
                  class="circle-score"
                >
                  <strong>96</strong>
                </div>
              </div>
            </div><p class="uni">ВШЭ</p><div class="divider"></div><div
              class="author"
            >
              <figure class="avatar">
                <img
                  loading="lazy"
                  src="https://images.unsplash.com/photo-1531123897727-8f129e1688ce?w=240&q=80&auto=format&fit=crop"
                  alt=""
                />
              </figure><div class="author-info">
                <p class="author-name">Даша Коваль</p><p class="tg-line">
                  <img
                    src="https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg"
                    alt=""
                  /><span class="tg-handle">@dashak</span>
                </p><p class="review">
                  “Поддержка в чате и еженедельные разборы — топ.”
                </p>
              </div>
            </div><div class="child-cards">
              <figure class="child left">
                <img
                  src="https://images.unsplash.com/photo-1513258496099-48168024aec0?w=900&q=80&auto=format&fit=crop"
                  alt=""
                />
              </figure><figure class="child right">
                <img
                  src="https://images.unsplash.com/photo-1461749280684-dccba630e2f6?w=900&q=80&auto=format&fit=crop"
                  alt=""
                />
              </figure>
            </div>
          </article>
        </li>
      </ul>
    </div>
  </div>

  <button class="cases-nav next" type="button" aria-label="Следующие кейсы"
  ></button>

  <!-- попап -->
  <div class="popup-overlay" id="popup">
    <div class="popup-content">
      <button class="popup-close" aria-label="Закрыть">×</button>
      <img src="" alt="Просмотр изображения" id="popup-img" />
    </div>
  </div>

  <!-- JS оставлен без изменений -->
  <script is:inline>
    (function () {
      const slider = document.currentScript.closest(".cases-slider");
      const viewport = slider.querySelector(
        ".cases-viewport-inner"
      ); /* ИЗМЕНЕНО: трекаем внутреннее окно */
      const track = slider.querySelector(".cases-track");
      const slides = [...slider.querySelectorAll(".cases-slide")];
      const prevBtn = slider.querySelector(".cases-nav.prev");
      const nextBtn = slider.querySelector(".cases-nav.next");
      const popup = slider.querySelector("#popup");
      const popupImg = slider.querySelector("#popup-img");
      const popupClose = slider.querySelector(".popup-close");

      let perView = 2,
        gap = 24,
        index = 0,
        slideW = 0,
        maxIndex = 0;

      function computePerView() {
        perView = window.innerWidth <= 1100 ? 1 : 2;
        gap = perView === 1 ? 0 : 70;
        track.style.gap = gap + "px";
      }

      function layout() {
        computePerView();

        const vw = viewport.clientWidth;
        slideW = (vw - gap * (perView - 1)) / perView;

        let cardScale = 1;
        if (perView === 1) {
          cardScale = Math.min(1, slideW / 550);
        }
        slider.style.setProperty("--card-scale", cardScale);

        slides.forEach((s) => (s.style.width = Math.round(slideW) + "px"));

        maxIndex = Math.max(0, slides.length - perView);
        index = Math.min(index, maxIndex);
        apply();
      }

      function apply() {
        const shift = -(index * (slideW + gap));
        track.style.transform = `translateX(${shift}px)`;
        prevBtn.disabled = index === 0;
        nextBtn.disabled = index === maxIndex;
      }

      prevBtn.addEventListener("click", () => {
        index = Math.max(0, index - 1);
        apply();
      });
      nextBtn.addEventListener("click", () => {
        index = Math.min(maxIndex, index + 1);
        apply();
      });

      window.addEventListener("resize", layout, { passive: true });
      layout();

      /* свайпы */
      let startX = 0,
        startY = 0,
        currentX = 0,
        isDragging = false,
        lockedAxis = null;
      const THRESHOLD = 50;
      const MAX_SLOPE = 0.57;

      function onPointerDown(e) {
        const t = e.touches ? e.touches[0] : e;
        startX = currentX = t.clientX;
        startY = t.clientY;
        isDragging = true;
        lockedAxis = null;
        track.style.transition = "none";
      }
      function onPointerMove(e) {
        if (!isDragging) return;
        const t = e.touches ? e.touches[0] : e;
        const dx = t.clientX - startX;
        const dy = t.clientY - startY;

        if (lockedAxis === null) {
          if (Math.abs(dx) > 8) {
            const slope = Math.abs(dy / dx);
            lockedAxis = slope <= MAX_SLOPE ? "x" : "y";
          }
        }
        if (lockedAxis === "x") {
          e.preventDefault();
          currentX = t.clientX;
          const base = -(index * (slideW + gap));
          track.style.transform = `translateX(${base + (currentX - startX)}px)`;
        }
      }
      function onPointerUp() {
        if (!isDragging) return;
        isDragging = false;
        track.style.transition = "transform .35s var(--easing)";
        if (lockedAxis !== "x") {
          apply();
          return;
        }

        const dx = currentX - startX;
        if (Math.abs(dx) > THRESHOLD) {
          if (dx < 0 && index < maxIndex) index += 1;
          if (dx > 0 && index > 0) index -= 1;
        }
        apply();
      }

      const outerViewport = slider.querySelector(".cases-viewport");
      outerViewport.addEventListener("touchstart", onPointerDown, {
        passive: true,
      });
      outerViewport.addEventListener("touchmove", onPointerMove, {
        passive: false,
      });
      outerViewport.addEventListener("touchend", onPointerUp, {
        passive: true,
      });
      outerViewport.addEventListener("touchcancel", onPointerUp, {
        passive: true,
      });
      outerViewport.addEventListener("mousedown", (e) => {
        onPointerDown(e);
        const mm = (ev) => onPointerMove(ev);
        const mu = () => {
          onPointerUp();
          window.removeEventListener("mousemove", mm);
        };
        window.addEventListener("mousemove", mm);
        window.addEventListener("mouseup", mu, { once: true });
      });

      /* попап */
      slider.querySelectorAll(".child img").forEach((img) => {
        img.addEventListener("click", () => {
          popupImg.src = img.src;
          popup.classList.add("active");
        });
      });
      popupClose.addEventListener("click", () =>
        popup.classList.remove("active")
      );
      popup.addEventListener("click", (e) => {
        if (e.target === popup) popup.classList.remove("active");
      });
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") popup.classList.remove("active");
      });
    })();
  </script>
</section>
