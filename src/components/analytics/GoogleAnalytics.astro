---
interface Props {
  /** GA4 Measurement ID, например G-Z72E04V1F9 */
  id?: string;
  /** Включать ли тег (удобно отключать в dev) */
  enabled?: boolean;
  /** Ручная отправка page_view (нужно для SPA-переходов в Astro) */
  sendPageViews?: boolean;
  /** Включить debug режим (видно в DebugView) */
  debug?: boolean;
}

const isProd = import.meta.env.PROD;
const {
  id = import.meta.env.PUBLIC_GA_ID ?? "G-Z72E04V1F9",
  enabled = true,
  sendPageViews = true,
  debug = false,
} = Astro.props;

const active = Boolean(isProd && enabled && id);
---

{
  active && (
    <>
      <script async src={`https://www.googletagmanager.com/gtag/js?id=${id}`} />
      <script>
        {`
        window.dataLayer = window.dataLayer || [];
        function gtag(){ dataLayer.push(arguments); }

        gtag('js', new Date());
        ${debug ? `gtag('set','debug_mode', true);` : ""}

        // ВАЖНО: отключаем авто page_view, чтобы не было дублей
        gtag('config', '${id}', { send_page_view: ${sendPageViews ? "false" : "true"}, anonymize_ip: true });

        ${
          sendPageViews
            ? `
          const sendPV = () => {
            gtag('event', 'page_view', {
              page_title: document.title,
              page_location: location.href,
              page_path: location.pathname
            });
          };
          document.addEventListener('astro:page-load', sendPV);
          document.addEventListener('astro:after-swap', sendPV);
        `
            : ""
        }
      `}
      </script>
    </>
  )
}
