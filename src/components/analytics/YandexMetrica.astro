---
// src/components/analytics/YandexMetrica.astro
interface Props {
  /** ID счётчика Метрики */
  id?: number | string;
  /** Включить/выключить (например, для dev окружения) */
  enabled?: boolean;
  /** Включать вебвизор */
  webvisor?: boolean;
  /** Имя dataLayer для e-commerce, false — не передавать ключ */
  ecommerceLayer?: string | false;
  /** Отправлять hit на SPA-навигации (astro view transitions) */
  sendOnNavigate?: boolean;
  /** Доп. флаги Метрики */
  clickmap?: boolean;
  trackLinks?: boolean;
  accurateTrackBounce?: boolean;
}

const isProd = import.meta.env.PROD;

const {
  id = import.meta.env.PUBLIC_YM_ID ?? 104058532, // ← твой ID по умолчанию
  enabled = true,
  webvisor = true,
  ecommerceLayer = "dataLayer",
  sendOnNavigate = true,
  clickmap = true,
  trackLinks = true,
  accurateTrackBounce = true,
} = Astro.props;

const active = Boolean(isProd && enabled && id);
const scriptSrc = `https://mc.yandex.ru/metrika/tag.js?id=${id}`;
---

{
  active && (
    <>
      <script>
        {`
        (function(m,e,t,r,i,k,a){
          m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
          m[i].l=1*new Date();
          for (var j = 0; j < document.scripts.length; j++) {
            if (document.scripts[j].src === r) { return; }
          }
          k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
        })(window, document, 'script', '${scriptSrc}', 'ym');

        ym(${id}, 'init', {
          ssr: true,
          webvisor: ${webvisor ? "true" : "false"},
          clickmap: ${clickmap ? "true" : "false"},
          ecommerce: ${ecommerceLayer ? `'${ecommerceLayer}'` : "undefined"},
          accurateTrackBounce: ${accurateTrackBounce ? "true" : "false"},
          trackLinks: ${trackLinks ? "true" : "false"}
        });

        // Доп. хиты для SPA-навигации (Astro View Transitions)
        (function(){
          if (!${sendOnNavigate ? "true" : "false"}) return;
          var first = true; // первый hit уже отправит Метрика при init
          var sendHit = function(){
            if (first) { first = false; return; }
            try { ym(${id}, 'hit', location.href); } catch (e) {}
          };
          document.addEventListener('astro:page-load', sendHit);
          document.addEventListener('astro:after-swap', sendHit);
        })();
      `}
      </script>

      <noscript>
        <div>
          <img
            src={`https://mc.yandex.ru/watch/${id}`}
            style="position:absolute; left:-9999px;"
            alt=""
          />
        </div>
      </noscript>
    </>
  )
}
