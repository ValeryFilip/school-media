---
import "../styles/global_lend.css";

import config from "../config.ts";
import PopupForm from "../components/PopupForm.astro";
import UnifiedMenu from "../components/UnifiedMenu.astro";
import SiteFooter from "../components/SiteFooter.astro";
import Seo from "../components/Seo.astro";
import Breadcrumbs from "../components/Breadcrumbs.astro";
import JsonLd from "../components/JsonLd.astro";
import { getCollection } from "astro:content";

interface Crumb {
  name: string;
  href?: string;
}

interface Props {
  title?: string;
  description?: string;
  image?: string;
  url?: string;
  seoType?: "website" | "article";
  noindex?: boolean;
  addSiteSuffix?: boolean;
  datePublished?: string;
  dateModified?: string;
  prevUrl?: string;
  nextUrl?: string;

  /* меню */
  categories?: string[];
  autoCategories?: boolean;
  logoSrc?: string;
  ctaHref?: string;

  /* крошки */
  breadcrumbs?: Crumb[];
  showBreadcrumbs?: boolean;
}
const {
  title,
  description,
  image,
  url,
  seoType = "website",
  noindex = false,
  addSiteSuffix = true,
  datePublished,
  dateModified,
  prevUrl,
  nextUrl,

  categories,
  autoCategories = true,
  logoSrc,
  ctaHref = "/courses/free",

  breadcrumbs = [],
  showBreadcrumbs = true,
} = Astro.props;

/* ——— helpers ——— */
function absUrl(u?: string) {
  if (!u) return undefined;
  if (/^https?:\/\//i.test(u)) return u;
  const base = config.siteUrl.replace(/\/$/, "");
  return u?.startsWith("/") ? base + u : `${base}/${u}`;
}

const pageTitle = title ?? config.siteName;
const pageDescription = description ?? config.description;
const pageUrl =
  url ?? `${config.siteUrl.replace(/\/$/, "")}${Astro.url.pathname}`;
const ogImage = absUrl(image);
const defaultOgImage = absUrl("/images/technical/og-home.png");

/* где мы сейчас: /media или корень */
const inMedia = Astro.url.pathname.startsWith("/media");

/* нормализация внутренних путей для пропсов (меню/кнопки и т.п.) */
const normalizeInternal = (p?: string) => {
  if (!p) return p;
  if (
    /^(https?:)?\/\//i.test(p) ||
    p.startsWith("mailto:") ||
    p.startsWith("tel:") ||
    p.startsWith("#")
  )
    return p;
  const clean = p.replace(/^\/+/, "");
  return (inMedia ? "/media/" : "/") + clean;
};
const ctaHrefNormalized = normalizeInternal(ctaHref);

/* Категории для меню */
let menuCategories: string[] = Array.isArray(categories) ? categories : [];
if ((!categories || categories.length === 0) && autoCategories) {
  const posts = await getCollection("articles");
  menuCategories = Array.from(
    new Set(
      posts.map((p) => String(p.data.category || "").trim()).filter(Boolean)
    )
  );
}
---

<!doctype html>
<html lang="ru" dir="ltr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- База ссылок: только на текущем разделе -->
    <base href={inMedia ? "/media/" : "/"} />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Jost:ital,wght@0,100..900;1,100..900&display=swap"
      rel="stylesheet"
    />

    <!-- Preload критичных ресурсов -->
    <link rel="preload" href="/logo.svg" as="image" type="image/svg+xml" />
    <link rel="preload" href="/favicon.ico" as="image" type="image/x-icon" />

    <Seo
      title={pageTitle}
      description={pageDescription}
      image={ogImage || (inMedia ? defaultOgImage : undefined)}
      url={pageUrl}
      type={seoType}
      noindex={noindex}
      addSiteSuffix={addSiteSuffix}
      datePublished={datePublished}
      dateModified={dateModified}
    />
    {prevUrl && <link rel="prev" href={absUrl(prevUrl)} />}
    {nextUrl && <link rel="next" href={absUrl(nextUrl)} />}

    <!-- RSS: всегда абсолютный -->
    <link
      rel="alternate"
      type="application/rss+xml"
      title={`${config.siteName} — RSS`}
      href="/rss.xml"
    />

    <!-- Иконки из корня — оставляем абсолютными -->
    <link rel="icon" href="/favicon.ico" sizes="any" />
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />

    <!-- Google reCAPTCHA v3 - только для продакшна -->
    <script>
      if (!window.location.hostname.includes("localhost")) {
        const script = document.createElement("script");
        script.src =
          "https://www.google.com/recaptcha/api.js?render=6LdH2McrAAAAAAjXZeXVKTAtKoGwJCjS4d9wVe4Z";
        script.async = true;
        script.defer = true;
        document.head.appendChild(script);
      }
    </script>

    <!-- ===== КРИТИЧНЫЕ СТИЛИ И СКРИПТЫ ===== -->

    <!-- Прелоадер - критичный для UX -->
    <style>
      .preloader {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        transition: opacity 0.3s ease;
      }
      .preloader--hidden {
        opacity: 0;
        pointer-events: none;
      }
      .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .is-loading .preloader {
        display: flex;
      }
    </style>

    <!-- Скрипт прелоадера - критичный для UX -->
    <script>
      (function () {
        /* ===== Прелоадер ===== */
        const preloader = document.getElementById("preloader");
        const hide = () => {
          preloader?.classList.add("preloader--hidden");
          document.body.classList.remove("is-loading");
        };
        if (document.readyState === "complete") hide();
        else {
          window.addEventListener("load", hide, { once: true });
          setTimeout(hide, 5000);
        }
        window.addEventListener("pageshow", (e) => {
          if (e.persisted) hide();
        });
      })();
    </script>

    <!-- Скрипт мобильного меню - критичный для UX -->
    <script>
      (function () {
        /* ===== Мобильное меню ===== */
        var btn = document.getElementById("menuToggle");
        var panel = document.getElementById("mobileMenu");
        var closeBtn = document.getElementById("menuClose");
        var backdrop = document.getElementById("mmenuBackdrop");

        if (!btn || !panel || !backdrop || !closeBtn) return;

        var focusableSelectors =
          'a[href], button:not([disabled]), input, select, textarea, [tabindex]:not([tabindex="-1"])';

        function openMenu() {
          panel.removeAttribute("hidden");
          backdrop.removeAttribute("hidden");
          btn.setAttribute("aria-expanded", "true");
          document.body.style.overflow = "hidden";

          // Фокус на первый элемент меню
          var firstFocusable = panel.querySelector(focusableSelectors);
          if (firstFocusable) firstFocusable.focus();
        }

        function closeMenu() {
          panel.setAttribute("hidden", "");
          backdrop.setAttribute("hidden", "");
          btn.setAttribute("aria-expanded", "false");
          document.body.style.overflow = "";
          btn.focus();
        }

        // Обработчики событий
        btn.addEventListener("click", openMenu);
        closeBtn.addEventListener("click", closeMenu);
        backdrop.addEventListener("click", closeMenu);

        // Закрытие по Escape
        document.addEventListener("keydown", function (e) {
          if (e.key === "Escape" && !panel.hasAttribute("hidden")) {
            closeMenu();
          }
        });

        // Ловушка фокуса в меню
        panel.addEventListener("keydown", function (e) {
          if (e.key === "Tab") {
            var focusableElements = panel.querySelectorAll(focusableSelectors);
            var firstElement = focusableElements[0];
            var lastElement = focusableElements[focusableElements.length - 1];

            if (e.shiftKey) {
              if (document.activeElement === firstElement) {
                e.preventDefault();
                lastElement.focus();
              }
            } else {
              if (document.activeElement === lastElement) {
                e.preventDefault();
                firstElement.focus();
              }
            }
          }
        });
      })();
    </script>

    <!-- JSON-LD структурированные данные -->
    <JsonLd
      type="website"
      data={{
        "@context": "https://schema.org",
        "@type": "WebSite",
        name: config.siteName,
        url: config.siteUrl,
        description: "Подготовка к ЕГЭ по химии: курсы, разборы и материалы",
        inLanguage: "ru",
        potentialAction: {
          "@type": "SearchAction",
          target: `${config.siteUrl.replace(/\/$/, "")}/media/search?q={query}`,
          "query-input": "required name=query",
        },
      }}
    />

    <JsonLd
      type="organization"
      data={{
        "@context": "https://schema.org",
        "@type": "Organization",
        name: config.siteName,
        url: config.siteUrl,
        description: "Подготовка к ЕГЭ по химии: курсы, разборы и материалы",
        logo: {
          "@type": "ImageObject",
          url: `${config.siteUrl.replace(/\/$/, "")}/images/technical/logo.png`,
          width: "60",
          height: "60",
        },
        contactPoint: {
          "@type": "ContactPoint",
          contactType: "customer service",
          url: `${config.siteUrl}/contact`,
        },
        sameAs: [
          "https://t.me/valery_chemistry",
          "https://vk.me/valeryfilip",
          "https://wa.me/79818364992",
        ],
      }}
    />

    <style>
      .page {
        min-height: 100dvh;
        display: flex;
        flex-direction: column;
        background: rgb(241, 245, 251);
      }
      .content {
        flex: 1 0 auto;
      }
      .skip-link {
        position: absolute;
        left: -9999px;
        top: auto;
        width: 1px;
        height: 1px;
        overflow: hidden;
      }
      .skip-link:focus {
        position: fixed;
        left: 16px;
        top: 12px;
        width: auto;
        height: auto;
        background: #fff;
        color: #000;
        border: 2px solid #1a73e8;
        border-radius: 6px;
        padding: 8px 12px;
        z-index: 10000;
      }
      .preloader {
        position: fixed;
        inset: 0;
        background: rgb(241, 245, 251);
        display: grid;
        place-items: center;
        z-index: 9999;
        transition:
          opacity 0.25s ease,
          visibility 0.25s ease;
      }
      .preloader--hidden {
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
      }
      .spinner {
        width: 44px;
        height: 44px;
        border: 4px solid #e6e6e6;
        border-top-color: #0d6efd;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .is-loading {
        overflow: hidden;
      }
    </style>
  </head>

  <body class={`page is-loading ${inMedia ? "media-page" : ""}`}>
    <!-- Прелоадер -->
    <div
      id="preloader"
      class="preloader"
      aria-live="polite"
      aria-busy="true"
      role="status"
    >
      <div class="spinner" aria-hidden="true"></div>
    </div>

    <a class="skip-link" href="#main">К содержимому</a>

    <!-- Меню медиа-раздела (UnifiedMenu) -->
    <UnifiedMenu
      variant="media"
      categories={menuCategories}
      logoSrc={logoSrc}
      ctaHref={ctaHrefNormalized}
      showSearch={true}
      searchAction="/media/search"
    />

    {
      showBreadcrumbs && breadcrumbs.length > 0 && (
        <Breadcrumbs items={breadcrumbs} />
      )
    }

    <main id="main" class="content">
      <slot />
    </main>

    <!-- Единый попап формы -->
    <PopupForm
      popupId="lead-popup"
      title="Оставьте заявку — перезвоним"
      submitText="Отправить"
      action="https://script.google.com/macros/s/AKfycbwBa6ffRK05gATFowu7yBpdmJ28C4EUEFJdxFrPbA_ZqRNizN1JK_b94Hb8SuJ9KxuE/exec"
      utmSource="global-popup"
      utmMedium="organic"
      utmCampaign="default"
    />

    {inMedia ? <SiteFooter /> : <Footer />}

    <!-- ===== СКРИПТЫ (в правильном порядке) ===== -->

    <!-- 1. Внешние библиотеки -->
    <script src="/js/popup.js" defer></script>
    <script src="/js/leadcapture.js" async></script>

    <!-- 2. Inline скрипты инициализации -->
    <!-- Прелоадер уже в head -->
  </body>
</html>
