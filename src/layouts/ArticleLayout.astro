---
// src/layouts/ArticleLayout.astro
import type { CollectionEntry } from "astro:content";
import { getCollection } from "astro:content";
import Card from "../components/Card.astro";
import CatBadge from "../components/CatBadge.astro";
import JsonLd from "../components/JsonLd.astro";
import { slugify } from "../lib/slugify";
import "../styles/media.css";

// —Ç–∏–ø—ã –ø—Ä–æ–ø—Å–æ–≤
interface Props {
  fm: CollectionEntry<"articles">["data"] & {
    toc?: { id: string; text: string }[];
    authorName?: string;
    authorRole?: string;
    authorPhoto?: string;
    authorImage?: string;
    heroImage?: string;
    hero?: string;
    cover?: string;
    headerImage?: string;
    imageAlt?: string;
    heroAlt?: string;
    updated?: string | Date;
    articleBody?: string; // –ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—å–∏ –¥–ª—è JSON-LD
  };
  slug: string;
  headings?: { depth: number; slug: string; text: string }[];
}
const { fm, slug, headings = [] } = Astro.props;

/* === –æ–∫—Ä—É–∂–µ–Ω–∏–µ –∏ –±–∞–∑–æ–≤—ã–π –ø—Ä–µ—Ñ–∏–∫—Å (/media) === */
const origin = Astro.url.origin;
const inMedia = Astro.url.pathname.startsWith("/media");
const base = inMedia ? "/media" : ""; // –ø—Ä–µ—Ñ–∏–∫—Å –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –ø—É—Ç–µ–π

/* === –∞–±—Å–æ–ª—é—Ç–Ω—ã–µ URL === */
const articleUrl = `${origin}${base}/articles/${slug}`;
const categorySlug = slugify(String(fm.category || ""));
const categoryUrl = `${origin}${base}/category/${categorySlug}`;

/* === —É—Ç–∏–ª–∏—Ç—ã === */
function toDate(value: unknown): Date | null {
  if (value instanceof Date) return value;
  if (typeof value === "string" || typeof value === "number") {
    const d = new Date(value);
    return isNaN(d.getTime()) ? null : d;
  }
  return null;
}
const dateObj = toDate(fm.date);
const updatedObj = toDate((fm as any).updated) || dateObj;

function formatDate(d: Date | null) {
  if (!d) return "";
  return d.toLocaleDateString("ru-RU", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
}

function resolveSrc(input: unknown): string | null {
  if (!input) return null;
  const s = String(input).trim();
  if (!s) return null;
  if (/^https?:\/\//i.test(s)) return s;
  if (s.startsWith("/")) return s;
  return "/" + s.replace(/^\.?\//, "");
}
const absAsset = (p?: string | null) => {
  if (!p) return undefined;
  if (/^https?:\/\//i.test(p)) return p;
  return `${origin}${p.startsWith("/") ? p : "/" + p}`;
};

/* === –∞–≤—Ç–æ—Ä === */
const authorName = fm.authorName || fm.author || "–ë–µ–∑ –∏–º–µ–Ω–∏";
const authorRole = fm.authorRole || "–≠–∫—Å–ø–µ—Ä—Ç –ø–æ —Ç–µ–º–µ";
const authorPhoto =
  resolveSrc((fm as any).authorPhoto) ||
  resolveSrc((fm as any).authorImage) ||
  "/images/stepik/researcher.webp";

/* === HERO === */
const heroFromFM =
  resolveSrc((fm as any).heroImage) ||
  resolveSrc((fm as any).hero) ||
  resolveSrc((fm as any).cover) ||
  resolveSrc((fm as any).headerImage) ||
  resolveSrc((fm as any).image) ||
  null;
const heroAlt = fm.heroAlt ?? fm.imageAlt ?? fm.title;

/* === TOC === */
const tocFromFM = Array.isArray(fm.toc) && fm.toc.length ? fm.toc : null;
const tocFromMD = headings
  .filter((h) => h.depth === 2 || h.depth === 3)
  .map((h) => ({ id: h.slug, text: h.text, depth: h.depth }));

/* === JSON-LD —Å—Ç–∞—Ç—å–∏ === */
const jsonLdArticle = {
  "@context": "https://schema.org",
  "@type": "Article",
  headline: fm.title,
  description: fm.description,
  image: heroFromFM
    ? {
        "@type": "ImageObject",
        url: absAsset(heroFromFM),
        width: "1200",
        height: "630",
      }
    : undefined,
  url: articleUrl,
  inLanguage: "ru-RU",
  keywords: Array.isArray(fm.tags) ? fm.tags : [],
  articleSection: fm.category || undefined,
  author: {
    "@type": "Person",
    name: authorName,
    url: `${origin}/about`,
    ...(authorPhoto ? { image: absAsset(authorPhoto) } : {}),
    jobTitle: authorRole,
    worksFor: {
      "@type": "Organization",
      name: "EGEHIM",
    },
  },
  publisher: {
    "@type": "Organization",
    name: "EGEHIM",
    url: origin,
    logo: {
      "@type": "ImageObject",
      url: `${origin}/images/technical/logo.png`,
      width: "60",
      height: "60",
    },
    description: "–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –ï–ì–≠ –ø–æ —Ö–∏–º–∏–∏: –∫—É—Ä—Å—ã, —Ä–∞–∑–±–æ—Ä—ã –∏ –º–∞—Ç–µ—Ä–∏–∞–ª—ã",
    contactPoint: {
      "@type": "ContactPoint",
      contactType: "customer service",
      url: `${origin}/contact`,
    },
    sameAs: ["https://t.me/valery_chemistry", "https://vk.me/valeryfilip"],
  },
  ...(dateObj ? { datePublished: dateObj.toISOString() } : {}),
  ...(updatedObj ? { dateModified: updatedObj.toISOString() } : {}),
  mainEntityOfPage: {
    "@type": "WebPage",
    "@id": articleUrl,
  },
  // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—å–∏ –¥–ª—è –ª—É—á—à–µ–≥–æ SEO
  ...(fm.articleBody ? { articleBody: fm.articleBody } : {}),
};

/* === BreadcrumbList –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ === */
const breadcrumbData = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: [
    {
      "@type": "ListItem",
      position: 1,
      name: "–ì–ª–∞–≤–Ω–∞—è",
      item: origin,
    },
    {
      "@type": "ListItem",
      position: 2,
      name: "–ú–µ–¥–∏–∞",
      item: `${origin}/media`,
    },
    {
      "@type": "ListItem",
      position: 3,
      name: fm.category || "–°—Ç–∞—Ç—å–∏",
      item: `${origin}/media/category/${categorySlug}`,
    },
    {
      "@type": "ListItem",
      position: 4,
      name: fm.title,
      item: articleUrl,
    },
  ],
};

/* === –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ–º—ã —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–∫—Å—Ç–∞ —Å—Ç–∞—Ç—å–∏ === */
const theme = (fm as any).theme ?? "light"; // light | dark
const accent = (fm as any).accent ?? "blue"; // blue | orange | green ...
const typography = (fm as any).typography ?? "sans"; // sans | serif

/* === ¬´–ï—â—ë –ø–æ —Ç–µ–º–µ¬ª: —Ç–∞ –∂–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è, –Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É === */
const allArticles = await getCollection("articles");
function getTimeSafe(p: CollectionEntry<"articles">): number {
  const v = (p.data as any)?.date;
  const d = v instanceof Date ? v : new Date(v);
  return isNaN(d.getTime()) ? 0 : d.getTime();
}
const currentCategory = String(fm.category ?? "").toLowerCase();
const sameCategoryTop = allArticles
  .filter(
    (p) =>
      p.slug !== slug &&
      String(p.data?.category ?? "").toLowerCase() === currentCategory
  )
  .sort((a, b) => getTimeSafe(b) - getTimeSafe(a))
  .slice(0, 8);
---

<!-- JSON-LD —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ -->
<JsonLd type="article" data={jsonLdArticle as any} />
<JsonLd type="breadcrumb" data={breadcrumbData as any} />

<!-- –ü—Ä–æ–≥—Ä–µ—Å—Å —á—Ç–µ–Ω–∏—è -->
<div class="progress" aria-hidden="true">
  <div class="progress__track"></div>
  <div id="progressBar" class="progress__bar"></div>
</div>

<!-- –ï–î–ò–ù–°–¢–í–ï–ù–ù–´–ô <main> -->
<main id="main" class="article-section" aria-labelledby="article-title">
  <div class="container">
    <div class="article-grid">
      <article class="article" itemscope itemtype="https://schema.org/Article">
        <div class="meta">
          {
            dateObj && (
              <time datetime={dateObj.toISOString()} itemprop="datePublished">
                {formatDate(dateObj)}
              </time>
            )
          }
          {fm.readingTime && <span>¬∑ {fm.readingTime}</span>}
          <span class="meta-cat">
            ¬∑ <CatBadge
              name={fm.category}
              href={`${base}/category/${categorySlug}`}
              variant="soft"
              size="sm"
            />
          </span>
        </div>

        <h1 id="article-title" class="title" itemprop="headline">{fm.title}</h1>
        {
          fm.description && (
            <p class="lead" itemprop="description">
              {fm.description}
            </p>
          )
        }

        <address
          class="author"
          itemprop="author"
          itemscope
          itemtype="https://schema.org/Person"
        >
          <img
            class="author__avatar"
            src={authorPhoto}
            alt={`${authorName} ‚Äî –∞–≤—Ç–æ—Ä —Å—Ç–∞—Ç—å–∏`}
            loading="lazy"
          />
          <div>
            <p class="author__name" itemprop="name">{authorName}</p>
            <p class="author__role">{authorRole}</p>
          </div>
        </address>

        <div class="above-content">
          <div class="hero" id="hero">
            <figure>
              <div
                class="hero__box"
                id="heroBox"
                aria-label="–ò–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—è –∫ —Å—Ç–∞—Ç—å–µ"
              >
                {
                  heroFromFM && (
                    <img
                      class="hero__img"
                      src={heroFromFM}
                      alt={heroAlt}
                      width="300"
                      height="300"
                      loading="eager"
                      fetchpriority="high"
                      decoding="async"
                    />
                  )
                }
              </div>
              <figcaption>{(fm as any).imageCaption ?? fm.title}</figcaption>
            </figure>
          </div>

          <nav class="toc" aria-labelledby="toc-title" data-toc-levels="h2,h3">
            <div id="toc-title" class="toc__title">–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ</div>
            <ol id="tocList">
              {
                tocFromFM
                  ? tocFromFM.map((item) => (
                      <li>
                        <a href={`${Astro.url.pathname}#${item.id}`}>
                          {item.text}
                        </a>
                      </li>
                    ))
                  : tocFromMD.map((item) => (
                      <li
                        style={
                          item.depth === 3 ? "margin-left:12px" : undefined
                        }
                      >
                        <a href={`${Astro.url.pathname}#${item.id}`}>
                          {item.text}
                        </a>
                      </li>
                    ))
              }
            </ol>
          </nav>
        </div>

        <!-- –¢–û–õ–¨–ö–û —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—å–∏ —Å—Ç–∏–ª–∏–∑—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ media.css -->
        <section
          class="content theme-media prose"
          itemprop="articleBody"
          data-theme={theme}
          data-accent={accent}
          data-typography={typography}
        >
          <slot />
        </section>

        {
          fm.tags && fm.tags.length > 0 && (
            <div class="tags-bottom" aria-label="–¢–µ–≥–∏">
              {fm.tags.map((t, i) => (
                <>
                  <a rel="tag" href={`${base}/tags/${slugify(String(t))}`}>
                    #{t}
                  </a>
                  {i < fm.tags.length - 1 ? " " : ""}
                </>
              ))}
            </div>
          )
        }

        <hr class="sep" />

        <section class="share" aria-labelledby="share-title">
          <div class="share-row">
            <div class="share-left">
              <span class="share-label">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è:</span>
              <div class="soc">
                <a
                  class="soc__btn soc__btn--tg"
                  href={`https://t.me/share/url?url=${encodeURIComponent(articleUrl)}&text=${encodeURIComponent(fm.title)}`}
                  target="_blank"
                  rel="noopener"
                  aria-label="Telegram"
                  ><img
                    src="/images/technical/telegram.png"
                    alt=""
                    width="22"
                    height="22"
                    loading="lazy"
                    decoding="async"
                  /></a
                >
                <a
                  class="soc__btn soc__btn--vk"
                  href={`https://vk.com/share.php?url=${encodeURIComponent(articleUrl)}`}
                  target="_blank"
                  rel="noopener"
                  aria-label="VK"
                  ><img
                    src="/images/technical/vk.png"
                    alt=""
                    width="22"
                    height="22"
                    loading="lazy"
                    decoding="async"
                  /></a
                >
                <a
                  class="soc__btn soc__btn--wa"
                  href={`https://wa.me/?text=${encodeURIComponent(fm.title + " " + articleUrl)}`}
                  target="_blank"
                  rel="noopener"
                  aria-label="WhatsApp"
                  ><img
                    src="/images/technical/whatsapp.png"
                    alt=""
                    width="22"
                    height="22"
                    loading="lazy"
                    decoding="async"
                  /></a
                >
                <button
                  class="soc__btn soc__btn--copy"
                  type="button"
                  id="copyLink"
                  aria-label="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É">üîó</button
                >
              </div>
            </div>
          </div>
        </section>
      </article>

      <!-- sticky aside -->
      <aside class="sidebar" aria-label="–ü—Ä–æ–º–æ-–∫–æ–ª–æ–Ω–∫–∞">
        <div class="promo-col">
          <!-- –ë–∞–Ω–Ω–µ—Ä: –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ Telegram -->
          <a
            class="promo banner banner--tg promo--short"
            href="https://t.me/"
            target="_blank"
            rel="noopener"
            aria-label="–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –Ω–∞—à Telegram-–∫–∞–Ω–∞–ª"
          >
            <div class="banner__row">
              <img
                class="banner__icon"
                src="/images/technical/telegram.png"
                alt=""
                width="28"
                height="28"
              />
              <span class="banner__kicker">Telegram</span>
            </div>
            <div class="banner__content">
              <strong class="banner__title">–ü–æ–¥–ø–∏—Å—ã–≤–∞–π—Å—è –Ω–∞ –∫–∞–Ω–∞–ª</strong>
              <span class="banner__sub">–∞–Ω–æ–Ω—Å—ã, —Ä–∞–∑–±–æ—Ä—ã, –±–æ–Ω—É—Å-–º–∞—Ç–µ—Ä–∏–∞–ª—ã</span>
            </div>
            <span class="btn banner__btn">–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è</span>
          </a>

          <!-- –ë–∞–Ω–Ω–µ—Ä: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –ï–ì–≠ —Å —ç–∫—Å–ø–µ—Ä—Ç–æ–º -->
          <div
            class="promo banner banner--ege promo--tall"
            role="region"
            aria-label="–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –ï–ì–≠ –ø–æ —Ö–∏–º–∏–∏"
          >
            <div class="banner__kicker">–ï–ì–≠ –ø–æ —Ö–∏–º–∏–∏</div>
            <div class="banner__content">
              <strong class="banner__title">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å —ç–∫—Å–ø–µ—Ä—Ç–æ–º</strong>
              <span class="banner__sub"
                >–∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω ¬∑ –ø—Ä–æ–±–Ω–æ–µ –∑–∞–Ω—è—Ç–∏–µ</span
              >
            </div>
            <button
              type="button"
              class="btn popup-btn banner__btn"
              data-popup-id="lead-popup"
              data-utm-source="article-sidebar"
              data-utm-medium="cta"
              data-utm-campaign="ege-prep"
              aria-label="–û—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É">–û—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button
            >
          </div>
        </div>
      </aside>
    </div>
  </div>

  {/* –ï—â—ë –ø–æ —Ç–µ–º–µ - –í–ù–£–¢–†–ò main –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å–µ–º–∞–Ω—Ç–∏–∫–∏ */}
  {
    sameCategoryTop.length > 0 && (
      <section class="more-section" aria-labelledby="more-title">
        <div class="container">
          <h2 id="more-title" class="more-title">
            –ï—â—ë –ø–æ —Ç–µ–º–µ
          </h2>
          <div class="more-grid">
            {sameCategoryTop.map((post) => (
              <Card
                post={post}
                preset="v-270x492"
                basePath={base}
                border={true}
                clampTitle={4}
                clampDesc={2}
              />
            ))}
          </div>
        </div>
      </section>
    )
  }
</main>
<style>
  :root {
    --page-max-width: 1300px;
    --page-padding: 50px;
    --gap: 15px;
    --radius: 24px;
    --c-text: #222;
    --c-meta: #666;
    --c-card: #fff;
    --c-border: #222;
    --accent: #0d6efd;
    --progress-h: 4px;
  }

  .progress {
    position: fixed;
    inset: 0 0 auto 0;
    height: var(--progress-h);
    z-index: 9999;
    pointer-events: none;
  }
  .progress__track {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.05);
  }
  .progress__bar {
    height: 100%;
    width: 0%;
    background: linear-gradient(
      90deg,
      var(--accent),
      #6ea8fe 50%,
      var(--accent)
    );
    transition: width 0.1s ease;
  }

  .article-section {
    margin: 0 0 50px;
    background: #f8f9fa;
    min-height: 100vh;
    width: 100%;
    box-sizing: border-box;
  }

  .article-section .container {
    max-width: var(--page-max-width);
    padding: 0 var(--page-padding);
    margin: 0 auto;
    box-sizing: border-box;
    overflow: visible;
  }

  .article-grid {
    display: grid;
    grid-template-columns: minmax(0, 1fr) 330px;
    gap: var(--gap);
    align-items: start;
    padding: 30px 0;
    width: 100%;
    box-sizing: border-box;
  }

  /* ===== –ê–î–ê–ü–¢–ò–í–ù–´–ï –°–¢–ò–õ–ò ===== */

  /* –ü–ª–∞–Ω—à–µ—Ç: —É–º–µ–Ω—å—à–∞–µ–º —à–∏—Ä–∏–Ω—É aside */
  @media (max-width: 1200px) {
    .article-section .container {
      padding: 0 30px;
    }

    .article-grid {
      grid-template-columns: minmax(0, 1fr) 280px;
      gap: 20px;
      padding: 25px 0;
    }

    .sidebar {
      max-height: calc(100vh - 40px);
    }
  }

  /* –ú–æ–±–∏–ª—å–Ω—ã–π: aside –≤–Ω–∏–∑—É */
  @media (max-width: 900px) {
    .article-section .container {
      padding: 0 20px;
    }

    .article-grid {
      grid-template-columns: 1fr;
      gap: 30px;
      padding: 20px 0;
    }

    .sidebar {
      position: static;
      order: 2;
      max-height: none;
    }

    .article {
      order: 1;
    }
  }

  .article {
    background: var(--c-card);
    border-radius: var(--radius);
    padding: 30px;
    color: var(--c-text);
    width: 100%;
    box-sizing: border-box;
  }
  .meta {
    color: var(--c-meta);
    font-size: 16px;
    display: flex;
    flex-wrap: wrap;
    gap: 10px 18px;
    margin: 0 0 20px;
  }
  .meta a:not(.cat-badge) {
    color: var(--accent);
    text-decoration: none;
  }
  .meta a:not(.cat-badge):hover {
    text-decoration: underline;
  }
  .meta-cat {
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }

  .title {
    font-weight: 700;
    font-size: 54px;
    line-height: 1.15;
    margin: 0 0 25px;
  }

  /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ */
  @media (max-width: 1200px) {
    .title {
      font-size: 48px;
    }
  }

  @media (max-width: 900px) {
    .title {
      font-size: 42px;
    }

    .more-title {
      font-size: 48px;
    }
  }

  @media (max-width: 600px) {
    .article-section .container {
      padding: 0 15px;
    }

    .article-grid {
      padding: 15px 0;
    }

    .title {
      font-size: 36px;
      line-height: 1.2;
    }

    .more-title {
      font-size: 36px;
    }

    .article {
      padding: 20px;
    }
  }

  .lead {
    font-size: 20px;
    margin: 0 0 25px;
  }

  .author {
    display: flex;
    gap: 16px;
    align-items: center;
    margin: 0 0 25px;
  }

  /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è author */
  @media (max-width: 600px) {
    .author {
      flex-direction: column;
      text-align: center;
      gap: 12px;
    }

    .author__avatar {
      width: 80px;
      height: 80px;
    }

    .author__name {
      font-size: 18px;
    }

    .author__role {
      font-size: 14px;
    }
  }
  .author__avatar {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    object-fit: cover;
    flex: 0 0 auto;
  }
  .author__name {
    font-size: 20px;
    margin: 0 0 4px;
    font-weight: 400;
  }
  .author__role {
    font-size: 16px;

    margin: 0;
  }

  .above-content {
    display: flex;
    gap: 30px;
    align-items: flex-start;
    margin: 0 0 25px;
  }

  /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è hero –∏ toc */
  @media (max-width: 900px) {
    .above-content {
      flex-direction: column;
      gap: 20px;
    }

    .hero__box {
      width: 100%;
      max-width: 400px;
      margin: 0 auto;
    }

    .toc {
      height: auto;
      min-height: 200px;
      max-height: 300px;
    }
  }

  @media (max-width: 600px) {
    .hero__box {
      width: 100%;
      max-width: 300px;
    }

    .toc {
      min-height: 150px;
      max-height: 250px;
    }
  }
  .hero figure {
    margin: 0;
  }
  .hero__box {
    width: 300px;
    height: 300px;
    aspect-ratio: 1/1;
    flex: 0 0 300px;
    min-width: 300px;
    border-radius: var(--radius);
    background: #e5e7eb;
    position: relative;
    overflow: hidden;
  }
  .hero__img {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .hero figcaption {
    font-size: 14px;
    color: #777;
    margin-top: 8px;
  }

  .toc {
    margin: 0;
    padding: 20px;
    border: 1px solid #e5e7eb;
    border-radius: 16px;
    background: #fafafa;
    flex: 1 1 auto;
    height: 300px;
    min-height: 300px;
    display: flex;
    flex-direction: column;
    overflow: auto;
  }
  .toc__title {
    font-size: 30px;
    font-weight: 700;
    margin: 0 0 10px;
    flex: 0 0 auto;
  }
  .toc ol {
    margin: 0;
    padding-left: 18px;
    flex: 1 1 auto;
  }
  .toc a {
    color: var(--accent);
    text-decoration: none;
    font-size: 16px;
  }
  .toc a:hover {
    text-decoration: underline;
  }

  .content :global(figure) {
    margin: 18px 0;
  }
  .content :global(img) {
    width: 100%;
    height: auto;
    border-radius: 16px;
    display: block;
  }
  .content :global(figcaption) {
    font-size: 14px;
    color: #777;
    margin-top: 6px;
  }

  .tags-bottom {
    margin: 20px 0 0;
    color: #0d6efd;
    line-height: 1.8;
    font-size: 16px;
    word-break: break-word;
  }
  .tags-bottom a {
    color: #0d6efd;
    text-decoration: none;
  }
  .tags-bottom a:hover {
    text-decoration: underline;
  }

  .sep {
    border: 0;
    border-top: 1px solid #e5e7eb;
    margin: 16px 0 0;
  }

  .share {
    margin-top: 0;
  }
  .share-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 16px;
    flex-wrap: wrap;
  }

  /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è share —Å–µ–∫—Ü–∏–∏ */
  @media (max-width: 600px) {
    .share-row {
      flex-direction: column;
      align-items: center;
      gap: 20px;
    }

    .share-left {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
    }

    .share-label {
      font-size: 16px;
      font-weight: 600;
    }

    .soc {
      justify-content: center;
      gap: 12px;
    }
  }
  .share-left {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .soc {
    display: flex;
    gap: 10px;
  }
  .soc__btn {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: grid;
    place-items: center;
    background: #fff;
    text-decoration: none;
    transition: all 0.2s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    border: 1px solid #e5e7eb;
  }
  .soc__btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    border-color: #d1d5db;
  }
  .soc__btn img {
    width: 28px;
    height: 28px;
    display: block;
  }
  .soc__btn--tg {
    background: #fff;
  }
  .soc__btn--vk {
    background: #fff;
  }
  .soc__btn--wa {
    background: #fff;
  }
  .soc__btn--copy {
    background: #fff;
    font-size: 20px;
    color: #374151;
  }

  .sidebar {
    position: sticky;
    top: 24px;
    align-self: start;
    height: fit-content;
    max-height: calc(100vh - 48px);
    overflow-y: auto;
    width: 100%;
    box-sizing: border-box;
  }
  .promo-col {
    width: 100%;
    display: flex;
    flex-direction: column;
    gap: var(--gap);
    box-sizing: border-box;
  }
  .promo {
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: var(--radius);
    padding: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #666;
    text-align: center;
    flex-shrink: 0;
    width: 100%;
    box-sizing: border-box;
  }
  /* ‚Äî –ë–∞–Ω–Ω–µ—Ä—ã ‚Äî */
  .banner {
    position: relative;
    display: grid;
    gap: 10px;
    text-align: left;
    overflow: hidden;
    width: 100%;
    box-sizing: border-box;
  }
  .banner__row {
    display: flex;
    align-items: center;
    gap: 10px;
    width: 100%;
    box-sizing: border-box;
    flex-wrap: nowrap;
    word-wrap: break-word;
    overflow-wrap: break-word;
    hyphens: auto;
  }
  .banner__icon {
    width: 28px;
    height: 28px;
    display: block;
    flex-shrink: 0;
  }
  .banner__kicker {
    font-size: 12px;
    font-weight: 600;
    letter-spacing: 0.02em;
    opacity: 0.8;
    flex: 1;
    min-width: 0;
    word-wrap: break-word;
    overflow-wrap: break-word;
    hyphens: auto;
  }
  .banner__title {
    font-size: 20px;
    line-height: 1.2;
    flex: 1;
    min-width: 0;
    word-wrap: break-word;
    overflow-wrap: break-word;
    hyphens: auto;
    text-overflow: ellipsis;
  }
  .banner__content {
    flex: 1;
    min-width: 0;
    word-wrap: break-word;
    overflow-wrap: break-word;
    hyphens: auto;
    text-overflow: ellipsis;
  }
  .banner__sub {
    font-size: 13px;
    color: #777;
    flex: 1;
    min-width: 0;
    word-wrap: break-word;
    overflow-wrap: break-word;
    hyphens: auto;
    text-overflow: ellipsis;
  }
  .banner__btn {
    justify-self: start;
    margin-top: 6px;
    flex: 1;
    min-width: 0;
    word-wrap: break-word;
    overflow-wrap: break-word;
    hyphens: auto;
    text-overflow: ellipsis;
  }

  .banner--tg {
    background: linear-gradient(135deg, #2793e6 0%, #2aa5e1 50%, #38bdf8 100%);
    color: #fff;
    border-color: rgba(255, 255, 255, 0.35);
  }
  .banner--tg .banner__kicker {
    color: #dff3ff;
  }
  .banner--tg .banner__sub {
    color: #e9f6ff;
  }
  .banner--tg .btn {
    background: #fff;
    color: #0b69b7;
    border: 1px solid rgba(255, 255, 255, 0.7);
  }

  .banner--ege {
    /* –º—è–≥–∫–∏–π –ø–∞—Å—Ç–µ–ª—å–Ω—ã–π –º–Ω–æ–≥–æc–ª–æ–π–Ω—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç */
    background: radial-gradient(
        600px 240px at -10% -20%,
        #fde1e7 0%,
        transparent 60%
      ),
      radial-gradient(420px 220px at 110% 120%, #d9f0ff 0%, transparent 58%),
      linear-gradient(135deg, #f9fafb 0%, #eef2ff 100%);
    color: #0f172a;
    border-color: #e5e7eb;
  }
  .banner--ege .banner__kicker {
    color: #475569;
  }
  .banner--ege .banner__sub {
    color: #64748b;
  }
  .promo--short {
    height: 200px;
  }
  .promo--tall {
    height: 300px;
  }

  /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è promo –±–∞–Ω–Ω–µ—Ä–æ–≤ */
  @media (max-width: 900px) {
    .promo-col {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
    }

    .promo--short,
    .promo--tall {
      height: auto;
      min-height: 200px;
    }
  }

  @media (max-width: 600px) {
    .promo-col {
      grid-template-columns: 1fr;
    }

    .promo {
      padding: 20px;
    }
  }

  .more-section {
    margin: 60px 0 60px;
    background: #f8f9fa;
    padding: 40px 0;
    width: 100%;
    box-sizing: border-box;
  }

  .more-section .container {
    max-width: var(--page-max-width);
    padding: 0 var(--page-padding);
    margin: 0 auto;
    box-sizing: border-box;
  }

  /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã –¥–ª—è more-section */
  @media (max-width: 1200px) {
    .more-section .container {
      padding: 0 30px;
    }
  }

  @media (max-width: 900px) {
    .more-section .container {
      padding: 0 20px;
    }

    .more-section {
      margin: 40px 0 40px;
      padding: 30px 0;
    }
  }

  @media (max-width: 600px) {
    .more-section .container {
      padding: 0 15px;
    }

    .more-section {
      margin: 30px 0 30px;
      padding: 20px 0;
    }
  }
  .more-title {
    font-size: 54px;
    font-weight: 700;
    margin: 0 0 24px;
  }
  .more-grid {
    display: grid;
    gap: 40px;
    grid-template-columns: repeat(4, 1fr);
    width: 100%;
    box-sizing: border-box;
  }

  /* –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è —Å–µ—Ç–∫–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π */
  @media (max-width: 1200px) {
    .more-grid {
      grid-template-columns: repeat(3, 1fr);
      gap: 30px;
    }
  }

  @media (max-width: 900px) {
    .more-grid {
      grid-template-columns: repeat(2, 1fr);
      gap: 25px;
    }
  }

  @media (max-width: 600px) {
    .more-grid {
      grid-template-columns: 1fr;
      gap: 20px;
    }
  }

  /* === FIX PACK: —É–±–∏—Ä–∞–µ–º –∞–≤—Ç–æ—Å–∫–µ–π–ª –∏ –¥–∞—ë–º –±–ª–æ–∫—É —Å–∂–∏–º–∞—Ç—å—Å—è === */

  /* –ì–∏–±–∫–∏–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ */
  .article-section .container,
  .more-section .container {
    padding-inline: clamp(12px, 4vw, var(--page-padding));
  }

  /* –°—Ç—Ä–∞—Ö–æ–≤–∫–∞ –æ—Ç –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ —Å–∫—Ä–æ–ª–ª–∞ –∏ ¬´—Ä–∞—Å—Ç—è–≥–∏–≤–∞—Ç–µ–ª–µ–π¬ª */
  html,
  body {
    overflow-x: hidden;
  }
  .article-section,
  .article,
  .above-content,
  .toc,
  .promo,
  .banner,
  .share-row {
    min-width: 0;
  }

  /* HERO: –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ 1:1 —Å —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ–º */
  .hero__box {
    width: 300px;
    height: 300px;
    aspect-ratio: 1 / 1;
    flex: 0 0 300px;
    min-width: 0;
  }

  .hero__img {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* HERO –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å: –º–æ–±–∏–ª - –ø–æ —Ü–µ–Ω—Ç—Ä—É, –ø–ª–∞–Ω—à–µ—Ç - 2 –∫–æ–ª–æ–Ω–∫–∏ */
  @media (max-width: 600px) {
    .above-content {
      flex-direction: column;
      gap: 20px;
    }

    .hero__box {
      width: 100%;
      max-width: 100%;
      margin: 0 auto;
    }
  }

  /* –ü–ª–∞–Ω—à–µ—Ç: hero —Å–ª–µ–≤–∞, toc —Å–ø—Ä–∞–≤–∞ –≤ 2 –∫–æ–ª–æ–Ω–∫–∏ */
  @media (min-width: 601px) and (max-width: 900px) {
    .above-content {
      flex-direction: row;
      gap: 30px;
      align-items: flex-start;
    }

    .hero__box {
      width: 200px;
      height: 200px;
      flex: 0 0 200px;
      margin: 0;
    }

    .toc {
      flex: 1;
      width: auto;
      max-height: 280px;
    }
  }

  /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è share —Å–µ–∫—Ü–∏–∏ –Ω–∞ –ø–ª–∞–Ω—à–µ—Ç–µ */
  @media (min-width: 601px) and (max-width: 900px) {
    .share-row {
      justify-content: center;
      gap: 30px;
    }

    .share-left {
      flex-direction: column;
      align-items: center;
      gap: 15px;
    }
  }

  /* TOC –Ω–µ –Ω–∞–≤—è–∑—ã–≤–∞–µ—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —à–∏—Ä–∏–Ω—É, —Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—Å—è */
  .toc {
    min-width: 0;
  }
  .toc a {
    word-break: break-word;
  }

  /* –ö–∞—Ä—Ç–æ—á–∫–∞ —Å—Ç–∞—Ç—å–∏ –æ—Å—Ç–∞—ë—Ç—Å—è —Ç–µ–∫—É—á–µ–π –∏ –Ω–µ ¬´—Ä–≤—ë—Ç¬ª —Å—Ç—Ä–æ–∫–∞–º–∏ */
  .article {
    max-width: 100%;
    overflow-wrap: anywhere;
  }

  /* –°–µ—Ç–∫–∞ –∏ –±–ª–æ–∫–∏ –Ω–∞ –ø–ª–∞–Ω—à–µ—Ç–µ/–º–æ–±–∏–ª–µ */
  @media (max-width: 900px) {
    .article-grid {
      grid-template-columns: 1fr;
      gap: 24px;
    }
    .above-content {
      flex-direction: column;
      gap: 20px;
    }
    .toc {
      width: 100%;
      max-height: 280px;
    }
  }

  @media (max-width: 600px) {
    .article {
      padding: 18px;
    }
    .title {
      font-size: clamp(26px, 6vw, 36px);
      line-height: 1.2;
    }
    .lead {
      font-size: clamp(16px, 4.4vw, 19px);
    }
    .author {
      flex-direction: column;
      gap: 12px;
      text-align: center;
    }
    .soc {
      flex-wrap: wrap;
    }
  }

  /* –û—á–µ–Ω—å —É–∑–∫–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω—ã */
  @media (max-width: 380px) {
    .article-section .container {
      padding-inline: 12px;
    }
    .banner__row {
      flex-wrap: wrap;
    }
    .soc__btn {
      width: 44px;
      height: 44px;
    }
  }
</style>
<!-- –ø–æ–¥–∫–ª—é—á–∞–µ–º —Å—Ç–∏–ª–∏ —Ç–∏–ø–æ–≥—Ä–∞—Ñ–∏–∫–∏ –¥–ª—è —Ç–µ–∫—Å—Ç–∞ —Å—Ç–∞—Ç—å–∏ -->
<style is:global>
  @import "../styles/global_media.css";
</style>

<script is:inline>
  // –ü—Ä–æ–≥—Ä–µ—Å—Å —á—Ç–µ–Ω–∏—è
  (function () {
    const bar = document.getElementById("progressBar");
    if (!bar) return;
    const docEl = document.documentElement;
    const onScroll = () => {
      const h = docEl.scrollHeight - docEl.clientHeight;
      const y = window.scrollY || window.pageYOffset || 0;
      const p = Math.max(0, Math.min(1, h ? y / h : 0));
      bar.style.width = (p * 100).toFixed(2) + "%";
    };
    let ticking = false;
    window.addEventListener(
      "scroll",
      () => {
        if (!ticking) {
          requestAnimationFrame(() => {
            onScroll();
            ticking = false;
          });
          ticking = true;
        }
      },
      { passive: true }
    );
    window.addEventListener("resize", onScroll, { passive: true });
    onScroll();
  })();

  // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏
  (function () {
    const btn = document.getElementById("copyLink");
    if (!btn) return;
    btn.addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText(location.href);
        btn.textContent = "‚úÖ";
        setTimeout(() => (btn.textContent = "üîó"), 1200);
      } catch (e) {}
    });
  })();

  // HERO: –µ—Å–ª–∏ –Ω–µ—Ç –∫–∞—Ä—Ç–∏–Ω–∫–∏ –≤ FM ‚Äî –≤–∑—è—Ç—å –ø–µ—Ä–≤—É—é –∏–∑ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
  (function () {
    const box = document.getElementById("heroBox");
    if (!box) return;
    if (box.querySelector("img")) return;

    const content = document.querySelector(".content");
    if (!content) return;

    const img = content.querySelector("img[data-hero], img");
    if (img && img.src) {
      const el = document.createElement("img");
      el.className = "hero__img";
      el.src = img.currentSrc || img.src;
      el.alt = "";
      el.loading = "lazy";
      el.decoding = "async";
      el.width = 300;
      el.height = 300;
      box.appendChild(el);
    }
  })();

  // TOC: —è–∫–æ—Ä—è –∫ —Ç–µ–∫—É—â–µ–º—É –ø—É—Ç–∏
  (function () {
    const content = document.querySelector(".content");
    const list = document.getElementById("tocList");
    const tocBox = document.querySelector(".toc");
    if (!content || !list || !tocBox) return;
    if (list.children.length > 0) return;

    const levels = (tocBox.getAttribute("data-toc-levels") || "h2,h3")
      .split(",")
      .map((s) => s.trim().toUpperCase())
      .filter(Boolean);

    const heads = content.querySelectorAll(levels.join(","));
    heads.forEach((h) => {
      if (!h.id) {
        h.id = (h.textContent || "")
          .trim()
          .toLowerCase()
          .replace(/[^\p{L}\p{N}\s-]/gu, "")
          .replace(/\s+/g, "-");
      }
      const li = document.createElement("li");
      if (h.tagName === "H3") li.style.marginLeft = "12px";
      const a = document.createElement("a");
      a.href = location.pathname + "#" + h.id;
      a.textContent = h.textContent || "";
      li.appendChild(a);
      list.appendChild(li);
    });
  })();
</script>

<!-- ===== –°–ö–†–ò–ü–¢–´ –°–¢–ê–¢–¨–ò (–≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ) ===== -->
