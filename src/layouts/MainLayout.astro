---
import "../styles/global_lend.css";
import config from "../config.ts";
import UnifiedMenu from "../components/UnifiedMenu.astro";
import Breadcrumbs from "../components/Breadcrumbs.astro";
import Seo from "../components/Seo.astro";
import SiteFooter from "../components/SiteFooter.astro";
import ExternalScripts from "../components/scripts/ExternalScripts.astro";
import YandexMetrika from "../components/analytics/YandexMetrika.astro";
import GoogleAnalytics from "../components/analytics/GoogleAnalytics.astro";
import JsonLd from "../components/JsonLd.astro";
import PopupForm from "../components/PopupForm.astro";
import {
  buildOrganizationJsonLd,
  buildWebSiteJsonLd,
  buildBreadcrumbsJsonLd,
  getSiteName,
} from "../lib/seoData";

interface Crumb {
  name: string;
  href?: string;
}
interface Props {
  title?: string;
  description?: string;
  image?: string;
  url?: string;
  seoType?: "website" | "article";
  index?: boolean;
  follow?: boolean;
  addSiteSuffix?: boolean;
  siteName?: string;
  imageAlt?: string;
  datePublished?: string;
  dateModified?: string;
  prevUrl?: string;
  nextUrl?: string;

  /* меню */
  logoSrc?: string;
  ctaHref?: string;

  /* крошки */
  breadcrumbs?: Crumb[];
  showBreadcrumbs?: boolean;

  /* дополнительные JSON-LD */
  articleJsonLd?: any;
  videoJsonLd?: any;
  courseJsonLd?: any;
  productJsonLd?: any;
  faqJsonLd?: any;
  webPageJsonLd?: any;
}
const {
  title,
  description,
  image,
  url,
  seoType = "website",
  index = true,
  follow = true,
  addSiteSuffix = true,
  siteName,
  imageAlt,
  datePublished,
  dateModified,
  prevUrl,
  nextUrl,

  logoSrc,
  ctaHref = "/allcourses",

  breadcrumbs = [],
  showBreadcrumbs = true,

  articleJsonLd,
  videoJsonLd,
  courseJsonLd,
  productJsonLd,
  faqJsonLd,
  webPageJsonLd,
} = Astro.props as Props;

const inAcademy = Astro.url.pathname.startsWith("/academy");
const pathname = Astro.url.pathname;

// Логотипы: курсы — весь сайт кроме академии, академия — раздел академии
const menuLogoSrc = inAcademy
  ? "/images/technical/egehim(academy).webp"
  : "/images/technical/egehim(kursi).webp";
const menuLogoAlt = inAcademy ? "ЕГЭХИМ — академия" : "ЕГЭХИМ — курсы";
// UTM source по странице: для попапа и кнопок CTA (меню, футер)
const pageUtmSource =
  pathname === "/"
    ? "main-page"
    : pathname.startsWith("/academy")
      ? "academy"
      : pathname.replace(/^\/|\/$/g, "").split("/")[0] || "main-page";
const origin = Astro.url.origin;
const siteNameFinal = getSiteName(siteName, config.siteName);

// Генерация JSON-LD
const orgJsonLd = buildOrganizationJsonLd(origin);
const websiteJsonLd = buildWebSiteJsonLd(origin, siteNameFinal);
const breadcrumbsJsonLd =
  showBreadcrumbs && breadcrumbs.length > 0
    ? buildBreadcrumbsJsonLd(
        origin,
        siteNameFinal,
        breadcrumbs,
        inAcademy,
        Astro.url.pathname,
      )
    : null;
---

<!doctype html>
<html lang="ru" dir="ltr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#366ef0" />
    {inAcademy && <base href="/academy/" />}

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Raleway:ital,wght@0,100..900;1,100..900&display=swap"
      media="print"
      onload="this.onload=null;this.media='all'"
    />
    <noscript>
      <link
        rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Raleway:ital,wght@0,100..900;1,100..900&display=swap"
      />
    </noscript>

    <Seo
      title={title ?? "ЕГЭХИМ"}
      description={description ??
        "Подготовка к ЕГЭ по химии: курсы, разборы и материалы"}
      image={image ?? "/images/technical/og-home.png"}
      url={url}
      type={seoType}
      index={index}
      follow={follow}
      addSiteSuffix={addSiteSuffix}
      siteName={siteName}
      imageAlt={imageAlt}
      datePublished={datePublished}
      dateModified={dateModified}
    />

    {prevUrl && <link rel="prev" href={prevUrl} />}
    {nextUrl && <link rel="next" href={nextUrl} />}

    <link
      rel="alternate"
      type="application/rss+xml"
      title={`${config.siteName} — RSS`}
      href="/rss.xml"
    />

    <link rel="manifest" href="/site.webmanifest" />
    <link rel="icon" href="/favicon.ico" type="image/x-icon" sizes="any" />
    <link
      rel="icon"
      href="/favicon-16x16.png"
      type="
      image
      png"
      sizes="16x16"
    />
    <link rel="icon" href="/favicon-32x32.png" type="image/png" sizes="32x32" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180" />

    <YandexMetrika />
    <GoogleAnalytics />

    {/* JSON-LD структурированные данные */}
    <JsonLd data={orgJsonLd} />
    <JsonLd data={websiteJsonLd} />
    {breadcrumbsJsonLd && <JsonLd data={breadcrumbsJsonLd} />}
    {articleJsonLd && <JsonLd data={articleJsonLd} />}
    {videoJsonLd && <JsonLd data={videoJsonLd} />}
    {courseJsonLd && <JsonLd data={courseJsonLd} />}
    {productJsonLd && <JsonLd data={productJsonLd} />}
    {faqJsonLd && <JsonLd data={faqJsonLd} />}
    {webPageJsonLd && <JsonLd data={webPageJsonLd} />}
  </head>
  <body class={`page is-loading ${inAcademy ? "academy-page" : ""}`}>
    <a href="#main" class="skip-link">Перейти к основному содержимому</a>
    <UnifiedMenu
      context={inAcademy ? "media" : "landing"}
      logoSrc={menuLogoSrc}
      logoAlt={menuLogoAlt}
      ctaHref={ctaHref}
      pageUtmSource={pageUtmSource}
    />
    {
      showBreadcrumbs && breadcrumbs.length > 0 && (
        <Breadcrumbs items={breadcrumbs} />
      )
    }
    <main id="main" class="content page-stack">
      <slot />
    </main>

    <SiteFooter pageUtmSource={pageUtmSource} />

    <PopupForm
      popupId="lead-popup"
      utmSource={pageUtmSource}
      utmMedium="organic"
      utmCampaign="popup-lead"
    />

    <ExternalScripts />
  </body>
</html>
