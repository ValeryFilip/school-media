---
import "../styles/global_lend.css";
import config from "../config.ts";
import UnifiedMenu from "../components/UnifiedMenu.astro";
import Breadcrumbs from "../components/Breadcrumbs.astro";
import Seo from "../components/Seo.astro";
import SiteFooter from "../components/SiteFooter.astro";
import PopupForm from "../components/PopupForm.astro";
import SupportFab from "../components/ui/SupportFab.astro";
import JsonLd from "../components/JsonLd.astro";

interface Crumb {
  name: string;
  href?: string;
}
interface Props {
  title?: string;
  description?: string;
  image?: string;
  url?: string;
  seoType?: "website" | "article";
  noindex?: boolean;
  addSiteSuffix?: boolean;
  siteName?: string;
  imageAlt?: string;
  categories?: string[];
  logoSrc?: string;
  ctaHref?: string;
  breadcrumbs?: Crumb[];
  showBreadcrumbs?: boolean;
}
const {
  title,
  description,
  image,
  url,
  seoType = "website",
  noindex = false,
  addSiteSuffix = true,
  siteName,
  imageAlt,
  categories,
  logoSrc,
  ctaHref = "/egecourse",
  breadcrumbs = [],
  showBreadcrumbs = true,
} = Astro.props as Props;

const origin = Astro.url.origin;
const siteUrl = (config as any)?.siteUrl || origin;
const orgJsonLd = {
  "@context": "https://schema.org",
  "@type": "Organization",
  name: (config as any)?.siteName || "EGEHIM",
  url: siteUrl,
  description: "Подготовка к ЕГЭ по химии: курсы, разборы и материалы",
  logo: {
    "@type": "ImageObject",
    url: `${siteUrl}/images/technical/logo.png`,
    width: "60",
    height: "60",
  },
  contactPoint: {
    "@type": "ContactPoint",
    contactType: "customer service",
    url: `${siteUrl}/contact`,
  },
  sameAs: [
    "https://t.me/valery_chemistry",
    "https://vk.me/valeryfilip",
    "https://wa.me/79818364992",
  ],
};

const websiteJsonLd = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  name: (config as any)?.siteName || "EGEHIM",
  url: siteUrl,
  description: "Подготовка к ЕГЭ по химии: курсы, разборы и материалы",
  inLanguage: "ru",
};
---

<!doctype html>
<html lang="ru" dir="ltr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter+Tight:ital,wght@0,100..900;1,100..900&display=swap"
      rel="stylesheet"
    />
    <Seo
      title={title ?? "EGEHIM"}
      description={description ??
        "Подготовка к ЕГЭ по химии: курсы, разборы и материалы"}
      image={image}
      url={url}
      type={seoType}
      noindex={noindex}
      addSiteSuffix={addSiteSuffix}
      siteName={siteName}
      imageAlt={imageAlt}
    />
    <!-- JSON-LD структурированные данные -->
    <JsonLd type="organization" data={orgJsonLd} />
    <JsonLd type="website" data={websiteJsonLd} />
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <link rel="icon" href="/favicon.ico" sizes="any" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />

    <!-- Google reCAPTCHA v3 - только для продакшна -->
    <script>
      if (!window.location.hostname.includes("localhost")) {
        const script = document.createElement("script");
        script.src =
          "https://www.google.com/recaptcha/api.js?render=6LdH2McrAAAAAAjXZeXVKTAtKoGwJCjS4d9wVe4Z";
        script.async = true;
        script.defer = true;
        document.head.appendChild(script);
      }
    </script>
    <meta name="theme-color" content="#0d6efd" />
    <meta name="color-scheme" content="light" />
    <style>
      .page {
        min-height: 100dvh;
        display: flex;
        flex-direction: column;
        background: var(--page-bg, #f1f5fb);
      }
      .content {
        flex: 1 0 auto;
      }
      .skip-link {
        position: absolute;
        left: -9999px;
        width: 1px;
        height: 1px;
        overflow: hidden;
      }
      .skip-link:focus {
        position: fixed;
        left: 16px;
        top: 12px;
        background: #fff;
        color: #000;
        border: 2px solid #1a73e8;
        border-radius: 6px;
        padding: 8px 12px;
        z-index: 10000;
      }
    </style>
  </head>
  <body class="page">
    <a class="skip-link" href="#main">К содержимому</a>

    <UnifiedMenu
      variant="landing"
      logoSrc="/images/logo_media.svg"
      logoAlt="ЕГЕХИМ"
      logoHref="/"
      navItems={[
        { label: "Главная", href: "/" },
        { label: "Медиа", href: "/media" },
      ]}
      dropdownLabel="Курсы"
      dropdownItems={[
        {
          label: "Самостоятельные курсы",
          href: "/allcourses",
          sub: "Идёшь в своём темпе",
        },
        { label: "Годовые курсы", href: "/", sub: "Группа и контроль" },
      ]}
      ctaText="Записаться"
      ctaHref={ctaHref}
      contacts={[
        {
          label: "Telegram",
          href: "https://t.me/valery_chemistry",
          imgSrc: "/images/technical/telegram.png",
        },
        {
          label: "WhatsApp",
          href: "https://wa.me/79818364992",
          imgSrc: "/images/technical/whatsapp.png",
        },
        {
          label: "VK",
          href: "https://vk.me/valeryfilip",
          imgSrc: "/images/technical/vk.png",
        },
      ]}
      contactsLabel="Напишите нам"
      showSearch={false}
    />
    {
      showBreadcrumbs && breadcrumbs.length > 0 && (
        <Breadcrumbs items={breadcrumbs} />
      )
    }

    <main id="main" class="content page-stack">
      <slot />
    </main>

    <!-- Единый попап -->
    <PopupForm
      popupId="lead-popup"
      title="Оставьте заявку — перезвоним"
      submitText="Отправить"
      action="https://script.google.com/macros/s/AKfycbwBa6ffRK05gATFowu7yBpdmJ28C4EUEFJdxFrPbA_ZqRNizN1JK_b94Hb8SuJ9KxuE/exec"
      utmSource="global-popup"
      utmMedium="organic"
      utmCampaign="default"
    />

    <SiteFooter />

    <!-- Плавающая кнопка поддержки (над стрелкой вверх) -->
    <SupportFab
      telegramUrl="https://t.me/valery_chemistry"
      whatsappUrl="https://wa.me/79818364992?text=%D0%9F%D1%80%D0%B8%D0%B2%D0%B5%D1%82!%20"
      vkUrl="https://vk.me/valeryfilip"
      bottomOffset={108}
      rightOffset={20}
      zIndex={9999}
    />

    <!-- ===== СКРИПТЫ (в правильном порядке) ===== -->

    <!-- 1. Внешние библиотеки -->
    <script src="/js/popup.js" defer></script>
    <script src="/js/leadcapture.js" async></script>
  </body>
</html>
