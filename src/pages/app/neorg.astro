---
/* self-contained astro page: no globals, no imports */
---

<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Тренажёр: названия неорганических веществ</title>
    <style>
      :root {
        --bg: #0b1020;
        --panel: #0f172a;
        --muted: #9aa3b2;
        --text: #e5e7eb;
        --accent: #22d3ee;
        --accent-2: #60a5fa;
        --ring: #334155;
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family:
          ui-sans-serif,
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          "Noto Sans",
          Ubuntu,
          Cantarell,
          "Helvetica Neue",
          Arial,
          "Apple Color Emoji",
          "Segoe UI Emoji";
        color: var(--text);
        background: radial-gradient(
            1200px 600px at 10% -10%,
            #1b2242 0,
            transparent 60%
          ),
          radial-gradient(1000px 500px at 110% -10%, #102338 0, transparent 60%),
          var(--bg);
        display: grid;
        place-items: center;
        padding: 24px;
      }
      .app {
        width: min(1120px, 100%);
        background: rgba(15, 23, 42, 0.66);
        backdrop-filter: blur(8px);
        border: 1px solid var(--ring);
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
        overflow: hidden;
      }
      header {
        padding: 20px 22px;
        border-bottom: 1px solid var(--ring);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
      }
      header h1 {
        font-size: 20px;
        margin: 0;
        letter-spacing: 0.2px;
      }
      header .note {
        font-size: 13px;
        color: var(--muted);
      }

      .main {
        display: grid;
        grid-template-columns: 1.3fr 0.7fr;
        gap: 24px;
        padding: 22px;
      }
      @media (max-width: 940px) {
        .main {
          grid-template-columns: 1fr;
        }
      }

      .panel {
        background: linear-gradient(
          180deg,
          rgba(2, 6, 23, 0.35),
          rgba(2, 6, 23, 0.2)
        );
        border: 1px solid var(--ring);
        border-radius: 16px;
        padding: 18px;
      }
      .panel h2 {
        margin: 0.2rem 0 1rem;
        font-size: 16px;
        color: #bcd1ff;
        font-weight: 600;
      }

      .formula-box {
        display: grid;
        gap: 12px;
      }
      .formula {
        font-size: 40px;
        letter-spacing: 1px;
        text-align: center;
        padding: 22px;
        border-radius: 14px;
        border: 1px dashed #3b455c;
        background: rgba(2, 6, 23, 0.35);
        min-height: 2.6em;
      }
      .formula sub {
        font-size: 0.58em;
      }
      .name {
        font-size: 18px;
        text-align: center;
        color: #cfe9ff;
        min-height: 1.6em;
      }

      .btns {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
      }
      button {
        appearance: none;
        border: none;
        border-radius: 12px;
        padding: 12px 16px;
        cursor: pointer;
        color: white;
        font-weight: 600;
        letter-spacing: 0.2px;
        transition:
          0.2s transform,
          0.2s box-shadow,
          0.2s background;
      }
      .btn-primary {
        background: linear-gradient(90deg, var(--accent), var(--accent-2));
        box-shadow: 0 6px 20px rgba(96, 165, 250, 0.25);
      }
      .btn-primary:hover {
        transform: translateY(-1px);
      }
      .btn-ghost {
        background: #0b1224;
        border: 1px solid var(--ring);
        color: #dbeafe;
      }

      .options {
        display: grid;
        gap: 14px;
      }
      .opt-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        flex-wrap: wrap;
      }
      .opt-row label {
        font-size: 14px;
        color: var(--muted);
      }
      .opt-row input[type="checkbox"] {
        width: 18px;
        height: 18px;
      }

      .hint {
        font-size: 13px;
        color: var(--muted);
      }
      .small {
        font-size: 12px;
        color: #9fb3c8;
      }
      .sep {
        height: 1px;
        background: var(--ring);
        margin: 14px 0;
      }
      .kbd {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        background: #0b1224;
        border: 1px solid var(--ring);
        border-radius: 6px;
        padding: 0 6px;
        font-size: 0.9em;
      }

      .mode,
      .supermode {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 6px;
        flex-wrap: wrap;
      }
      .toggle {
        background: #0b1224;
        border: 1px solid var(--ring);
        color: #dbeafe;
        padding: 8px 12px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
      }
      .toggle.active {
        outline: 2px solid var(--accent-2);
        box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.15);
      }
    </style>
  </head>
  <body>
    <div
      class="app"
      role="application"
      aria-label="Тренажёр по названиям неорганических веществ"
    >
      <header>
        <h1>Тренажёр: формула ↔ название</h1>
        <div class="note">
          Режимы: <b>Номенклатура</b> (ионы, кислоты, основные/комплексные соли,
          гидраты) и <b>Тривиальные названия</b>. Баланс зарядов, индексы и
          скобки — автоматически.
        </div>
      </header>

      <div class="main">
        <!-- Левая панель: рабочая зона -->
        <section class="panel">
          <h2>Задание</h2>
          <div class="formula-box" aria-live="polite">
            <div class="supermode">
              <button class="toggle active" data-base="iupac" id="btnBaseIUPAC"
                >Номенклатура</button
              >
              <button class="toggle" data-base="trivial" id="btnBaseTrivial"
                >Тривиальные</button
              >
            </div>
            <div class="mode">
              <button class="toggle active" data-mode="f2n" id="btnModeF2N"
                >Формула → название</button
              >
              <button class="toggle" data-mode="n2f" id="btnModeN2F"
                >Название → формула</button
              >
            </div>

            <div id="formula" class="formula" aria-label="Формула">—</div>

            <div class="btns">
              <button id="btnGen" class="btn-primary" type="button"
                >Сгенерировать</button
              >
              <button id="btnShow" class="btn-ghost" type="button" disabled
                >Показать ответ</button
              >
            </div>

            <div id="name" class="name" aria-label="Название" hidden>—</div>
            <div class="hint">
              Произнеси ответ → нажми <span class="kbd">Показать</span>. Сменить
              режим можно выше.
            </div>
          </div>
        </section>

        <!-- Правая панель: опции/описание -->
        <aside class="panel">
          <h2>Параметры</h2>
          <div class="options">
            <div class="opt-row">
              <label
                ><input type="checkbox" id="optOxides" checked /> Включать оксиды/пероксиды</label
              >
              <label
                ><input type="checkbox" id="optHydroxides" checked /> Включать гидроксиды</label
              >
            </div>
            <div class="opt-row">
              <label
                ><input type="checkbox" id="optAcidSalts" checked /> Кислые соли
                (гидро-)</label
              >
              <label
                ><input type="checkbox" id="optAmmonium" checked /> Разрешить катион
                NH₄⁺</label
              >
            </div>
            <div class="opt-row">
              <label
                ><input type="checkbox" id="optAcids" checked /> Включать кислоты</label
              >
              <label
                ><input type="checkbox" id="optBasicSalts" checked /> Включать основные
                соли</label
              >
            </div>
            <div class="opt-row">
              <label
                ><input type="checkbox" id="optComplexes" checked /> Гидроксокомплексы
                [Al/Zn/Be/Cr]</label
              >
              <label
                ><input type="checkbox" id="optHydrates" checked /> Кристаллогидраты</label
              >
            </div>
            <div class="opt-row">
              <label style="flex:1 1 auto"
                >Доля гидратов: <span id="hydrateProbLabel">20%</span></label
              >
              <input
                type="range"
                id="optHydrateProb"
                min="0"
                max="100"
                value="20"
                style="width:220px"
              />
            </div>
            <div class="opt-row">
              <label
                ><input type="checkbox" id="optStock" checked /> Степень окисления
                в названии (железа<small>(III)</small>)</label
              >
            </div>
            <div class="sep"></div>
            <p class="small">
              Скобки для многоатомных ионов при коэффициенте &gt; 1; квадратные
              — для комплексов: <span class="kbd">Ca(NO₃)₂</span>, <span
                class="kbd">K₂[Zn(OH)₄]</span
              >. Гидраты точкой: <span class="kbd">CuSO₄·5H₂O</span>.
            </p>
          </div>
        </aside>
      </div>
    </div>

    <script>
      // === Справочники (Номенклатура) ===
      const CATIONS = [
        { sym: "Na", name: "натрия", charge: 1 },
        { sym: "K", name: "калия", charge: 1 },
        { sym: "Li", name: "лития", charge: 1 },
        { sym: "Cs", name: "цезия", charge: 1 },
        { sym: "Rb", name: "рубидия", charge: 1 },
        { sym: "Ag", name: "серебра", charge: 1 },
        { sym: "NH4", name: "аммония", charge: 1, poly: true },

        { sym: "Mg", name: "магния", charge: 2 },
        { sym: "Be", name: "бериллия", charge: 2 },
        { sym: "Ca", name: "кальция", charge: 2 },
        { sym: "Sr", name: "стронция", charge: 2 },
        { sym: "Ba", name: "бария", charge: 2 },
        { sym: "Zn", name: "цинка", charge: 2 },
        { sym: "Hg", name: "ртути", charge: 2, stock: true, ox: 2 },

        { sym: "Al", name: "алюминия", charge: 3 },

        { sym: "Fe", name: "железа", charge: 2, stock: true, ox: 2 },
        { sym: "Fe", name: "железа", charge: 3, stock: true, ox: 3 },
        { sym: "Cu", name: "меди", charge: 1, stock: true, ox: 1 },
        { sym: "Cu", name: "меди", charge: 2, stock: true, ox: 2 },
        { sym: "Sn", name: "олова", charge: 2, stock: true, ox: 2 },
        { sym: "Pb", name: "свинца", charge: 2, stock: true, ox: 2 },
        { sym: "Cr", name: "хрома", charge: 2, stock: true, ox: 2 },
        { sym: "Cr", name: "хрома", charge: 3, stock: true, ox: 3 },
        { sym: "Mn", name: "марганца", charge: 2, stock: true, ox: 2 },
        { sym: "Co", name: "кобальта", charge: 2, stock: true, ox: 2 },
        { sym: "Ni", name: "никеля", charge: 2, stock: true, ox: 2 },
      ];

      const ANIONS = [
        { sym: "F", name: "фторид", charge: 1 },
        { sym: "Cl", name: "хлорид", charge: 1 },
        { sym: "Br", name: "бромид", charge: 1 },
        { sym: "I", name: "иодид", charge: 1 },
        { sym: "S", name: "сульфид", charge: 2 },
        { sym: "HS", name: "гидросульфид", charge: 1, poly: true, acid: true },
        { sym: "N", name: "нитрид", charge: 3 },
        { sym: "P", name: "фосфид", charge: 3 },
        { sym: "As", name: "арсенид", charge: 3 },
        { sym: "Se", name: "селенид", charge: 2 },
        { sym: "H", name: "гидрид", charge: 1 },
        { sym: "C", name: "карбид", charge: 4 },
        { sym: "Si", name: "силицид", charge: 4 },
        { sym: "O", name: "оксид", charge: 2 },

        { sym: "OH", name: "гидроксид", charge: 1, poly: true },
        { sym: "O2", name: "пероксид", charge: 2, poly: true },

        { sym: "NO3", name: "нитрат", charge: 1, poly: true },
        { sym: "NO2", name: "нитрит", charge: 1, poly: true },
        { sym: "CO3", name: "карбонат", charge: 2, poly: true },
        {
          sym: "HCO3",
          name: "гидрокарбонат",
          charge: 1,
          poly: true,
          acid: true,
        },
        { sym: "SO4", name: "сульфат", charge: 2, poly: true },
        { sym: "SO3", name: "сульфит", charge: 2, poly: true },
        {
          sym: "HSO4",
          name: "гидросульфат",
          charge: 1,
          poly: true,
          acid: true,
        },
        {
          sym: "HSO3",
          name: "гидросульфит",
          charge: 1,
          poly: true,
          acid: true,
        },
        { sym: "PO4", name: "фосфат", charge: 3, poly: true },
        { sym: "HPO4", name: "гидрофосфат", charge: 2, poly: true, acid: true },
        {
          sym: "H2PO4",
          name: "дигидрофосфат",
          charge: 1,
          poly: true,
          acid: true,
        },
        { sym: "HPO3", name: "фосфит", charge: 2, poly: true },
        {
          sym: "H2PO3",
          name: "гидрофосфит",
          charge: 1,
          poly: true,
          acid: true,
        },
        { sym: "H2PO2", name: "гипофосфит", charge: 1, poly: true, acid: true },
        { sym: "SiO3", name: "силикат", charge: 2, poly: true },
        {
          sym: "HSiO3",
          name: "гидросиликат",
          charge: 1,
          poly: true,
          acid: true,
        },

        { sym: "ClO", name: "гипохлорит", charge: 1, poly: true },
        { sym: "ClO2", name: "хлорит", charge: 1, poly: true },
        { sym: "ClO3", name: "хлорат", charge: 1, poly: true },
        { sym: "ClO4", name: "перхлорат", charge: 1, poly: true },
        { sym: "BrO", name: "гипобромит", charge: 1, poly: true },
        { sym: "BrO2", name: "бромит", charge: 1, poly: true },
        { sym: "BrO3", name: "бромат", charge: 1, poly: true },
        { sym: "BrO4", name: "пербромат", charge: 1, poly: true },
        { sym: "IO", name: "гипоиодит", charge: 1, poly: true },
        { sym: "IO2", name: "иодит", charge: 1, poly: true },
        { sym: "IO3", name: "иодат", charge: 1, poly: true },
        { sym: "IO4", name: "периодат", charge: 1, poly: true },

        { sym: "MnO4", name: "перманганат", charge: 1, poly: true },
        { sym: "MnO4", name: "манганат", charge: 2, poly: true },
        {
          sym: "HMnO4",
          name: "гидроманганат",
          charge: 1,
          poly: true,
          acid: true,
        },
        { sym: "CrO4", name: "хромат", charge: 2, poly: true },
        { sym: "Cr2O7", name: "дихромат", charge: 2, poly: true },
        {
          sym: "HCrO4",
          name: "гидрохромат",
          charge: 1,
          poly: true,
          acid: true,
        },

        { sym: "C2O4", name: "оксалат", charge: 2, poly: true },
        { sym: "CH3COO", name: "ацетат", charge: 1, poly: true },
        { sym: "CN", name: "цианид", charge: 1, poly: true },

        { sym: "AlO2", name: "алюминат", charge: 1, poly: true },
        { sym: "BeO2", name: "бериллат", charge: 2, poly: true },
        { sym: "ZnO2", name: "цинкат", charge: 2, poly: true },
        { sym: "FeO2", name: "феррит", charge: 1, poly: true },
      ];

      const ACIDS = [
        // Бескислородные
        { sym: "HF", name: "фтороводородная (плавиковая) кислота" },
        { sym: "HCl", name: "хлороводородная (соляная) кислота" },
        { sym: "HBr", name: "бромоводородная кислота" },
        { sym: "HI", name: "иодоводородная кислота" },
        { sym: "H2S", name: "сероводородная кислота" },
        { sym: "HCN", name: "циановодородная кислота" },

        // Кислородсодержащие
        { sym: "H2SO4", name: "серная кислота" },
        { sym: "H2SO3", name: "сернистая кислота" },
        { sym: "HNO3", name: "азотная кислота" },
        { sym: "HNO2", name: "азотистая кислота" },
        { sym: "H3PO4", name: "ортофосфорная кислота" },
        { sym: "H3PO3", name: "фосфористая кислота" },
        { sym: "H3PO2", name: "фосфорноватистая кислота" },
        { sym: "H2CO3", name: "угольная кислота" },
        { sym: "H2SiO3", name: "кремниевая кислота" },

        // Хлор-, бром-, иод- кислородные ряды
        { sym: "HClO4", name: "хлорная кислота" },
        { sym: "HBrO4", name: "бромная кислота" },
        { sym: "HIO4", name: "иодная кислота" },

        { sym: "HClO3", name: "хлорноватая кислота" },
        { sym: "HBrO3", name: "бромноватая кислота" },
        { sym: "HIO3", name: "иодноватая кислота" },

        { sym: "HClO2", name: "хлористая кислота" },
        { sym: "HBrO2", name: "бромистая кислота" },
        { sym: "HIO2", name: "иодистая кислота" },

        { sym: "HClO", name: "хлорноватистая кислота" },
        { sym: "HBrO", name: "бромноватистая кислота" },
        { sym: "HIO", name: "иодноватистая кислота" },

        // Марганец/хром/железо
        { sym: "HMnO4", name: "марганцовая кислота" },
        { sym: "H2MnO4", name: "марганцовистая кислота" },
        { sym: "H2CrO4", name: "хромовая кислота" },
        { sym: "H2Cr2O7", name: "дихромовая кислота" },
        { sym: "H2FeO4", name: "железная кислота" },
      ];

      const COMPLEX_ANIONS = [
        {
          sym: "[Al(OH)4]",
          name: "тетрагидроксоалюминат",
          charge: 1,
          poly: true,
          complex: true,
        },
        {
          sym: "[Zn(OH)4]",
          name: "тетрагидроксоцинкат",
          charge: 2,
          poly: true,
          complex: true,
        },
        {
          sym: "[Be(OH)4]",
          name: "тетрагидроксобериллат",
          charge: 2,
          poly: true,
          complex: true,
        },
        {
          sym: "[Cr(OH)6]",
          name: "гексагидроксохромат",
          charge: 3,
          poly: true,
          complex: true,
        },
      ];

      // === Тривиальные названия ===
      const TRIVIALS = [
        { formula: "C", names: ["алмаз", "графит", "сажа"] },
        {
          formula: "NH3·H2O",
          names: ["нашатырный спирт", "аммиачная вода", "водный раствор NH3"],
        },
        {
          formula: "KAl(SO4)2·12H2O",
          names: ["алюмокалиевые квасцы", "квасцы"],
        },
        { formula: "NH4Cl", names: ["нашатырь"] },
        { formula: "Ca(NO3)2", names: ["норвежская селитра"] },
        { formula: "H2SO4·SO3", names: ["олеум"] },
        { formula: "MnO2", names: ["пиролюзит"] },
        { formula: "BaSO4", names: ["барит"] },
        { formula: "NaHCO3", names: ["питьевая сода", "пищевая сода"] },
        { formula: "Ba(OH)2", names: ["баритовая вода"] },
        { formula: "K2CO3", names: ["поташ"] },
        { formula: "KClO3", names: ["бертолетова соль"] },
        { formula: "Pb(CH3COO)2·3H2O", names: ["свинцовый сахар"] },
        { formula: "CH4", names: ["болотный газ"] },
        { formula: "CO+H2", names: ["синтез-газ", "водяной газ"] },
        { formula: "NO2", names: ["бурый газ", "лисий хвост"] },
        { formula: "CO2", names: ["сухой лёд"] },
        { formula: "N2O", names: ["веселящий газ"] },
        { formula: "SO2", names: ["сернистый газ"] },
        { formula: "Fe2O3", names: ["гематит"] },
        { formula: "CaF2", names: ["флюорит"] },
        { formula: "2CaSO4*H2O", names: ["гипс", "алебастр"] },
        { formula: "COCl2", names: ["фосген"] },
        { formula: "Na2SO4·10H2O", names: ["глауберова соль"] },
        { formula: "PH3", names: ["фосфин"] },
        { formula: "H2+O2", names: ["гремучий газ"] },
        { formula: "C60", names: ["фуллерен"] },
        {
          formula: "NaOH",
          names: ["едкий натр", "каустик", "каустическая сода"],
        },
        { formula: "KOH", names: ["едкое кали"] },
        {
          formula: "Fe3O4",
          names: ["железная окалина", "магнетит", "магнитный железняк"],
        },
        { formula: "HCl+HNO3", names: ["царская водка"] },
        {
          formula: "FeS2",
          names: ["железный колчедан", "пирит", "серный колчедан"],
        },
        { formula: "ZnS", names: ["цинковая обманка"] },
        {
          formula: "FeSO4·7H2O",
          names: ["железный купорос", "купорос железный"],
        },
        { formula: "NaNO3", names: ["чилийская селитра"] },
        { formula: "KNO3", names: ["калиевая селитра"] },
        { formula: "NaCl", names: ["каменная соль", "поваренная соль"] },
        { formula: "SiC", names: ["карборунд"] },
        { formula: "HgS", names: ["киноварь"] },
        { formula: "SiO2", names: ["кремнезём", "кварц", "песок"] },
        { formula: "Na3[AlF6]", names: ["криолит"] },
        { formula: "Na2CO3·10H2O", names: ["кристаллическая сода"] },
        { formula: "AgNO3", names: ["ляпис", "адский камень"] },
        { formula: "MgO", names: ["магнезия жжёная"] },
        { formula: "Cu2(OH)2CO3", names: ["малахит"] },
        { formula: "KMnO4", names: ["марганцовка"] },
        { formula: "CuSO4·5H2O", names: ["медный купорос"] },
        { formula: "CaCO3", names: ["мел", "известняк", "мрамор", "кальцит"] },
        { formula: "Na2SiO3", names: ["жидкое стекло"] },
        { formula: "Na2O+CaO·6SiO2", names: ["стекло"] },
        { formula: "MgSO4·7H2O", names: ["английская соль", "горькая соль"] },
        { formula: "Cr2O3", names: ["хромовая зелень"] },
        { formula: "K2Cr2O7", names: ["хромпик"] },
      ];

      // === Утиль ===
      function randFrom(arr) {
        var u = new Uint32Array(1);
        crypto.getRandomValues(u);
        var i = u[0] % arr.length;
        return arr[i];
      }
      function gcd(a, b) {
        return b ? gcd(b, a % b) : Math.abs(a);
      }
      function lcm(a, b) {
        return Math.abs(a * b) / gcd(a, b);
      }
      function toRoman(n) {
        var m = {
          1: "I",
          2: "II",
          3: "III",
          4: "IV",
          5: "V",
          6: "VI",
          7: "VII",
          8: "VIII",
          9: "IX",
          10: "X",
        };
        return m[n] || String(n);
      }
      function prefixes(n) {
        var m = {
          1: "моно",
          2: "ди",
          3: "три",
          4: "тетра",
          5: "пента",
          6: "гекса",
          7: "гепта",
          8: "окта",
          9: "нона",
          10: "дека",
        };
        return m[n] || n + "-";
      }

      function pickAnion(options) {
        var oxides = options.oxides,
          hydroxides = options.hydroxides,
          acidSalts = options.acidSalts;
        var pool = ANIONS.filter(function (a) {
          if (!oxides && (a.sym === "O" || a.name.indexOf("пероксид") !== -1))
            return false;
          if (!hydroxides && a.sym === "OH") return false;
          if (!acidSalts && a.acid) return false;
          return true;
        });
        return randFrom(pool);
      }

      function pickCation(options) {
        var ammonium = options.ammonium;
        var pool = CATIONS.filter(function (c) {
          return ammonium ? true : c.sym !== "NH4";
        });
        return randFrom(pool);
      }

      function buildIonPairFormula(cation, anion) {
        var L = lcm(cation.charge, anion.charge);
        var nC = L / cation.charge;
        var nA = L / anion.charge;
        var cPart =
          cation.poly && nC > 1
            ? "(" + cation.sym + ")" + nC
            : cation.sym + (nC > 1 ? nC : "");
        var aPart;
        if (anion.poly && nA > 1) {
          aPart =
            anion.sym.indexOf("[") === 0
              ? anion.sym + nA
              : "(" + anion.sym + ")" + nA;
        } else {
          aPart = anion.sym + (nA > 1 ? nA : "");
        }
        return cPart + aPart;
      }

      function formatSubscripts(formulaStr) {
        return formulaStr.replace(/[0-9]+/g, function (m) {
          return "<sub>" + m + "</sub>";
        });
      }

      function buildStockTail(cation, showStock) {
        return showStock && cation.stock ? "(" + toRoman(cation.ox) + ")" : "";
      }

      function buildNameIonPair(cation, anion, showStock) {
        var stock = buildStockTail(cation, showStock);
        return anion.name + " " + cation.name + stock;
      }

      function generateBasicSalt(options) {
        var metals = CATIONS.filter(function (c) {
          return c.charge >= 2;
        });
        var c = randFrom(metals);
        var anPool = ANIONS.filter(function (a) {
          return a.sym !== "OH" && !a.acid;
        });
        var a = randFrom(anPool);
        var k = 1,
          y = 1;
        var candidates = [];
        for (var i = 1; i < c.charge; i++) {
          var rest = c.charge - i;
          if (rest > 0 && rest % a.charge === 0) {
            candidates.push(i);
          }
        }
        var tries = 0;
        while (candidates.length === 0 && tries < 20) {
          a = randFrom(anPool);
          tries++;
          for (var j = 1; j < c.charge; j++) {
            var rest2 = c.charge - j;
            if (rest2 > 0 && rest2 % a.charge === 0) {
              candidates.push(j);
            }
          }
        }
        if (candidates.length === 0) {
          var f = buildIonPairFormula(c, a);
          return { formulaRaw: f, name: buildNameIonPair(c, a, options.stock) };
        }
        k = randFrom(candidates);
        y = (c.charge - k) / a.charge;

        var ohPart = k > 1 ? "(OH)" + k : "OH";
        var aPart =
          a.poly && y > 1 ? "(" + a.sym + ")" + y : a.sym + (y > 1 ? y : "");
        var formulaRaw = c.sym + ohPart + aPart;

        var kPrefix = k > 1 ? prefixes(k) : "";
        var name = (
          kPrefix +
          (k > 1 ? "-" : "") +
          "гидроксо" +
          a.name +
          " " +
          c.name +
          buildStockTail(c, options.stock)
        ).replace("--", "-");
        return { formulaRaw: formulaRaw, name: name };
      }

      function generateComplexSalt(options) {
        var a = randFrom(COMPLEX_ANIONS);
        var c = pickCation(options);
        var formulaRaw = buildIonPairFormula(c, a);
        var name = a.name + " " + c.name + buildStockTail(c, options.stock);
        return { formulaRaw: formulaRaw, name: name };
      }

      function generateAcid() {
        var acid = randFrom(ACIDS);
        return { formulaRaw: acid.sym, name: acid.name };
      }

      function generateSimple(options) {
        var c = pickCation(options);
        var a = pickAnion(options);
        var formulaRaw = buildIonPairFormula(c, a);
        var name = buildNameIonPair(c, a, options.stock);
        return { formulaRaw: formulaRaw, name: name };
      }

      function maybeHydrate(obj, allowHydrates, probPct) {
        if (!allowHydrates) return obj;
        if (obj.type === "acid" || obj.type === "trivial") return obj;
        var p = Math.max(0, Math.min(100, Number(probPct) || 0)) / 100;
        if (Math.random() < p) {
          var nList = [1, 2, 3, 4, 5, 6, 7, 8, 10];
          var n = randFrom(nList);
          obj.formulaRaw = obj.formulaRaw + "·" + n + "H2O";
          obj.name = obj.name + " " + prefixes(n) + "гидрат";
        }
        return obj;
      }

      function generateTrivial() {
        var t = randFrom(TRIVIALS);
        var shownName = randFrom(t.names);
        return {
          formulaRaw: t.formula,
          name: t.names.join(" / "),
          shownName: shownName,
          type: "trivial",
        };
      }

      // === Взаимодействие ===
      var elFormula = document.getElementById("formula");
      var elName = document.getElementById("name");
      var btnGen = document.getElementById("btnGen");
      var btnShow = document.getElementById("btnShow");

      var btnBaseIUPAC = document.getElementById("btnBaseIUPAC");
      var btnBaseTrivial = document.getElementById("btnBaseTrivial");
      var btnModeF2N = document.getElementById("btnModeF2N");
      var btnModeN2F = document.getElementById("btnModeN2F");

      var optOxides = document.getElementById("optOxides");
      var optHydroxides = document.getElementById("optHydroxides");
      var optAcidSalts = document.getElementById("optAcidSalts");
      var optAmmonium = document.getElementById("optAmmonium");
      var optAcids = document.getElementById("optAcids");
      var optBasicSalts = document.getElementById("optBasicSalts");
      var optComplexes = document.getElementById("optComplexes");
      var optHydrates = document.getElementById("optHydrates");
      var optHydrateProb = document.getElementById("optHydrateProb");
      var hydrateProbLabel = document.getElementById("hydrateProbLabel");
      var optStock = document.getElementById("optStock");

      var current = null; // { formulaRaw, formulaHtml, name, type, shownName? }
      var mode = "f2n";
      var base = "iupac";

      function generate() {
        if (base === "trivial") {
          var objT = generateTrivial();
          current = {
            formulaRaw: objT.formulaRaw,
            name: objT.name,
            shownName: objT.shownName,
            type: objT.type,
            formulaHtml: formatSubscripts(objT.formulaRaw),
          };
          renderTask();
          return;
        }

        var options = {
          oxides: optOxides.checked,
          hydroxides: optHydroxides.checked,
          acidSalts: optAcidSalts.checked,
          ammonium: optAmmonium.checked,
          stock: optStock.checked,
        };

        var pool = ["simple"];
        if (optAcids.checked) pool.push("acid");
        if (optBasicSalts.checked) pool.push("basic");
        if (optComplexes.checked) pool.push("complex");
        var type = randFrom(pool);

        var obj;
        if (type === "acid") {
          obj = generateAcid();
        } else if (type === "basic") {
          obj = generateBasicSalt(options);
        } else if (type === "complex") {
          obj = generateComplexSalt(options);
        } else {
          obj = generateSimple(options);
        }
        obj.type = type;

        var hydrateProb = optHydrateProb ? optHydrateProb.value : 20;
        obj = maybeHydrate(obj, optHydrates.checked, hydrateProb);

        current = {
          formulaRaw: obj.formulaRaw,
          name: obj.name,
          type: obj.type,
          formulaHtml: formatSubscripts(obj.formulaRaw),
        };
        renderTask();
      }

      function renderTask() {
        if (!current) return;
        elName.hidden = true;
        elName.textContent = "—";
        elFormula.innerHTML = "—";
        btnShow.disabled = false;

        if (mode === "f2n") {
          elFormula.innerHTML = current.formulaHtml;
        } else {
          var text =
            base === "trivial" && current.shownName
              ? current.shownName
              : current.name;
          elName.textContent = text;
          elName.hidden = false;
        }
      }

      function showAnswer() {
        if (!current) return;
        if (mode === "f2n") {
          elName.textContent = current.name;
          elName.hidden = false;
        } else {
          elFormula.innerHTML = current.formulaHtml;
        }
      }

      btnGen.addEventListener("click", generate);
      btnShow.addEventListener("click", showAnswer);

      btnModeF2N.addEventListener("click", function () {
        mode = "f2n";
        btnModeF2N.classList.add("active");
        btnModeN2F.classList.remove("active");
        renderTask();
      });
      btnModeN2F.addEventListener("click", function () {
        mode = "n2f";
        btnModeN2F.classList.add("active");
        btnModeF2N.classList.remove("active");
        renderTask();
      });

      btnBaseIUPAC.addEventListener("click", function () {
        base = "iupac";
        btnBaseIUPAC.classList.add("active");
        btnBaseTrivial.classList.remove("active");
        renderTask();
      });
      btnBaseTrivial.addEventListener("click", function () {
        base = "trivial";
        btnBaseTrivial.classList.add("active");
        btnBaseIUPAC.classList.remove("active");
        renderTask();
      });

      if (optHydrateProb && hydrateProbLabel) {
        optHydrateProb.addEventListener("input", function () {
          hydrateProbLabel.textContent = String(optHydrateProb.value) + "%";
        });
        hydrateProbLabel.textContent = String(optHydrateProb.value) + "%";
      }

      generate();
    </script>
  </body>
</html>
