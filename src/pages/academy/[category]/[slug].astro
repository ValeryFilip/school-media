---
// src/pages/academy/[category]/[slug].astro — статья по URL /academy/КАТЕГОРИЯ/СЛАГ
import MainLayout from "../../../layouts/MainLayout.astro";
import ArticleLayoutNew from "../../../layouts/ArticleLayoutNew.astro";
import config from "../../../config.ts";
import { getCollection, getEntryBySlug } from "astro:content";
import { slugify } from "../../../lib/slugify";
import { calcReadingTime } from "../../../lib/calcReadingTime";
import { buildArticleJsonLd } from "../../../lib/seoData";

export async function getStaticPaths() {
  const posts = await getCollection("articles", ({ data }) => {
    return data.visible !== false;
  });
  return posts.map((post) => ({
    params: {
      category: slugify(String(post.data.category)),
      slug: post.slug,
    },
  }));
}

const { category: categorySlug, slug } = Astro.params;

const entry = await getEntryBySlug("articles", slug!);
if (!entry) throw new Error(`Статья "${slug}" не найдена`);

// Проверка: slug категории в URL должен совпадать с категорией статьи
if (slugify(String(entry.data.category)) !== categorySlug) {
  return Astro.redirect("/404");
}

// Проверка видимости статьи
if (entry.data.visible === false) {
  return Astro.redirect("/404");
}

const fm = {
  ...entry.data,
  readingTime: calcReadingTime(entry.body),
  tocManual: entry.data.tocManual
    ? entry.data.tocManual.map((item) => ({
        id: item.id || slugify(item.text),
        text: item.text,
      }))
    : undefined,
};

const { Content, headings } = await entry.render();

// Рекомендации (только видимые статьи)
const all = await getCollection("articles", ({ data }) => {
  return data.visible !== false;
});
const byTag = all.filter(
  (p) => p.slug !== slug && p.data.tags?.some((t) => fm.tags?.includes(t))
);
const byCategory = all.filter(
  (p) =>
    p.slug !== slug && p.data.category === fm.category && !byTag.includes(p)
);
const recommendations = [...byTag, ...byCategory].slice(0, 4);

const siteUrl = (Astro.site?.href ?? config.siteUrl).replace(/\/$/, "");
const pageUrl = `${siteUrl}/academy/${categorySlug}/${slug}/`;

const breadcrumbs = [
  {
    name: `${fm.category}`,
    href: `${siteUrl}/academy/${slugify(fm.category)}/`,
  },
  { name: fm.title },
];

const articleJsonLd = buildArticleJsonLd({
  origin: siteUrl,
  url: pageUrl,
  headline: fm.title,
  description: fm.description,
  image: fm.image,
  datePublished: new Date(fm.date as any).toISOString(),
  dateModified: (fm as any).updated
    ? new Date((fm as any).updated as any).toISOString()
    : new Date(fm.date as any).toISOString(),
  keywords: fm.tags?.length ? fm.tags : undefined,
  articleSection: fm.category,
});
---

<MainLayout
  title={fm.title}
  description={fm.description}
  image={fm.image}
  url={pageUrl}
  seoType="article"
  datePublished={new Date(fm.date as any).toISOString()}
  dateModified={(fm as any).updated
    ? new Date((fm as any).updated as any).toISOString()
    : new Date(fm.date as any).toISOString()}
  breadcrumbs={breadcrumbs}
  articleJsonLd={articleJsonLd}
>
  <ArticleLayoutNew fm={fm} slug={slug!} headings={headings}>
    <Content />
  </ArticleLayoutNew>
</MainLayout>
