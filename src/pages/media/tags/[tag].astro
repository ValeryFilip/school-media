---
// src/pages/tags/[tag].astro
import MainLayout from "../../../layouts/MainLayout.astro";
import config from "../../../config.ts";
import { getCollection } from "astro:content";
import CardNew from "../../../components/cards/cardNew.astro";
import CardHorizontal from "../../../components/cards/CardHorizontal.astro";
import Pagination from "../../../components/Pagination.astro";
import { slugify } from "../../../lib/slugify";
import { withReadingTime } from "../../../lib/withReadingTime";

export async function getStaticPaths() {
  const posts = await getCollection("articles", ({ data }) => {
    return data.visible !== false;
  });
  const seen = new Set<string>();
  const tags = posts.flatMap((p) =>
    Array.isArray(p.data.tags) ? p.data.tags : []
  );
  const unique = Array.from(new Set(tags.filter(Boolean).map(String)));

  return unique.reduce<{ params: { tag: string } }[]>((acc, t) => {
    const s = slugify(t);
    if (!s || seen.has(s)) return acc;
    seen.add(s);
    acc.push({ params: { tag: s } });
    return acc;
  }, []);
}

const { tag: slug } = Astro.params;

const allRaw = await getCollection("articles", ({ data }) => {
  return data.visible !== false;
});

const all = withReadingTime(allRaw);

// Найти оригинальное имя тега по слагу
const tagMap = new Map<string, string>();
for (const p of all) {
  const tags = Array.isArray(p.data.tags) ? p.data.tags : [];
  for (const t of tags) {
    const s = slugify(String(t));
    if (s && !tagMap.has(s)) tagMap.set(s, String(t));
  }
}
const originalTag = tagMap.get(slug) || slug;

const toDate = (v: any) => (v instanceof Date ? v : new Date(v));
const posts = all
  .filter(
    (p) =>
      Array.isArray(p.data.tags) &&
      p.data.tags.some((t) => slugify(String(t)) === slug)
  )
  .sort(
    (a, b) => toDate(b.data.date).getTime() - toDate(a.data.date).getTime()
  );

// Левая колонка - основные статьи
const leftCards = posts;

// Правая колонка - случайные 5 статей
const shuffled = [...posts].sort(() => Math.random() - 0.5);
const rightCards = shuffled.slice(0, 5);

// Пагинация для левой колонки
const PER_PAGE = 6;
const currentPage = Math.max(
  1,
  Number(Astro.url.searchParams.get("page") || "1")
);
const totalPages = Math.max(1, Math.ceil(leftCards.length / PER_PAGE));
const pagedLeftCards = leftCards.slice(
  (currentPage - 1) * PER_PAGE,
  currentPage * PER_PAGE
);

const siteUrl = config.siteUrl.replace(/\/$/, "");
function humanizeTag(t: string): string {
  const s = t.trim();
  return s.charAt(0).toUpperCase() + s.slice(1);
}
const pageTitle = humanizeTag(originalTag);
const pageDesc = `Подборка статей по тегу «${pageTitle}»: разборы, полезные материалы и практические советы по теме.`;
const pageUrl = `${siteUrl}/media/tags/${encodeURIComponent(slug)}/`;

const breadcrumbs = [{ name: pageTitle, href: pageUrl }];

// Для отображения количества статей
const totalArticles = posts.length;
---

<MainLayout
  title={pageTitle}
  description={pageDesc}
  url={`${pageUrl}${currentPage > 1 ? `?page=${currentPage}` : ""}`}
  image={posts[0]?.data?.image || "/images/technical/og-home.png"}
  prevUrl={currentPage > 1 ? `${pageUrl}?page=${currentPage - 1}` : undefined}
  nextUrl={currentPage < totalPages
    ? `${pageUrl}?page=${currentPage + 1}`
    : undefined}
  breadcrumbs={breadcrumbs}
>
  <main class="main container">
    <section class="header">
      <div class="header__wrapper">
        <h1 class="header__title" data-count={totalArticles}>{pageTitle}</h1>
        <p class="header__description">{pageDesc}</p>
      </div>
    </section>

    <section class="main-cards">
      <div class="left-block__grid" id="grid-initial">
        {
          pagedLeftCards.map((post) => (
            <div class="ad-media__card">
              <CardNew post={post} basePath="/media" />
            </div>
          ))
        }
      </div>

      <div class="popular">
        <h2 class="popular__title">Популярное</h2>
        <div class="popular__cards">
          {
            rightCards.map((post) => (
              <CardHorizontal post={post} basePath="/media" />
            ))
          }
        </div>
      </div>
    </section>

    {/* Шаблоны карточек для клиентской пагинации */}
    {
      leftCards.map((post) => (
        <template id={`tmpl-${post.slug}`}>
          <div class="ad-media__card">
            <CardNew post={post} basePath="/media" />
          </div>
        </template>
      ))
    }

    <Pagination
      currentPage={currentPage}
      totalPages={totalPages}
      pathname={Astro.url.pathname}
      perPage={PER_PAGE}
    />
  </main>
</MainLayout>

<style>
  .header__wrapper {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    margin-bottom: 60px;
  }
  .header__wrapper p {
    margin: 0;
  }
  .header__title::after {
    content: attr(data-count);
    margin-left: 8px;
    color: #929292;
    font-weight: 700;
    font-size: 32px;
  }
  .main-cards {
    display: grid;
    grid-template-columns: 1fr 0.3fr;
    gap: 30px;
    align-items: start;
  }
  .left-block__grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 20px;
  }
  .ad-media__card {
    display: flex;
    align-items: flex-start;
  }
  .popular__title {
    font-size: 32px;
    font-weight: 700;
    line-height: 1.2;
    margin: 0;
    margin-bottom: 20px;
  }

  .popular__cards {
    display: grid;
    grid-template-columns: 1fr;
    gap: 30px;
  }

  @media (max-width: 1100px) {
    .main-cards {
      grid-template-columns: 1fr;
    }
  }
</style>
