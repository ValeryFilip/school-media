---
// src/pages/media/index.astro
import MainLayout from "../../layouts/MainLayout.astro";
import config from "../../config.ts";
import { getCollection } from "astro:content";
import { getCategoryHex } from "../../lib/categoryColors.ts";
import { slugify } from "../../lib/slugify.ts";
import CardNew from "../../components/cards/cardNew.astro";
import CardHorizontal from "../../components/cards/CardHorizontal.astro";
import LeadCapture from "../../components/mainpage/LeadCapture.astro";
import AdFreeBanner from "../../components/mainpage/AdFreeBanner.astro";
import SideCategoryScroller from "../../components/SideCategoryScroller.astro";
import { withReadingTime } from "../../lib/withReadingTime";

// Получаем все видимые статьи и сортируем по дате (от новых к старым)
const toDate = (v: any) => (v instanceof Date ? v : new Date(v));
const allPostsRaw = (
  await getCollection("articles", ({ data }) => {
    return data.visible !== false;
  })
).sort((a, b) => toDate(b.data.date).getTime() - toDate(a.data.date).getTime());

const allPosts = withReadingTime(allPostsRaw);

// Функция для фильтрации по категории
const filterByCategory = (category: string) =>
  allPosts.filter(
    (p) =>
      String(p.data.category || "").toLowerCase() === category.toLowerCase()
  );

// Категории
const categories = [
  { id: "news", label: "Новости", slug: "новости" },
  { id: "school", label: "Школьникам", slug: "школьникам" },
  { id: "parents", label: "Родителям", slug: "родителям" },
  { id: "enrol", label: "Поступление", slug: "поступление" },
  { id: "psych", label: "Психология", slug: "психология" },
  { id: "adults", label: "Как быть взрослым", slug: "как быть взрослым" },
  { id: "chemistry", label: "Материалы по химии", slug: "материалы по химии" },
  {
    id: "ege-oge",
    label: "Материалы для ЕГЭ и ОГЭ по химии",
    slug: "материалы для егэ и огэ по химии",
  },
  { id: "video", label: "Видео", slug: "видео" },
]
  .filter((cat) => filterByCategory(cat.slug).length > 0)
  .map((c) => ({ ...c, color: getCategoryHex(c.label) }));

// Секция 1: home-grid (1 CardNew + 8 CardHorizontal)
const section1Posts = filterByCategory("новости");
const section1Main = section1Posts.slice(0, 1);
const section1Horizontal = section1Posts.slice(1, 8);

// Секция 2: home-grid-2 (1 CardNew + 8 CardHorizontal)
const section2Posts = filterByCategory("школьникам");
const section2Main = section2Posts.slice(0, 1);
const section2Horizontal = section2Posts.slice(1, 8);

// Секция 3: home-grid-3 (2 CardNew + 6 CardHorizontal)
const section3Posts = filterByCategory("родителям");
const section3Vertical = section3Posts.slice(0, 2);
const section3Horizontal = section3Posts.slice(2, 8);

// Секция 4: home-grid-4 (6 CardNew)
const section4Posts = filterByCategory("видео");
const section4Vertical = section4Posts.slice(0, 8);

// Секция 5: home-grid-5 (2 CardNew + остальные CardNew)
const section5Posts = filterByCategory("психология");
const section5Vertical = section5Posts.slice(0, 6);

// Секция 6: Как быть взрослым (6 CardNew)
const section6Posts = filterByCategory("как быть взрослым");
const section6Vertical = section6Posts.slice(0, 6);

// Секция 7: Материалы по химии (6 CardNew)
const section7Posts = filterByCategory("материалы по химии");
const section7Vertical = section7Posts.slice(0, 6);

// Секция 8: Материалы для ЕГЭ и ОГЭ по химии (6 CardNew)
const section8Posts = filterByCategory("материалы для егэ и огэ по химии");
const section8Vertical = section8Posts.slice(0, 6);

// SEO (приоритет — Astro.site из astro.config)
const site = (Astro.site?.href ?? config.siteUrl).replace(/\/$/, "");
const pageTitle = "Медиа — статьи и материалы по химии, ЕГЭ и ОГЭ";
const pageDesc =
  "Статьи, разборы и материалы по химии: подготовка к ЕГЭ и ОГЭ, теория, практика и советы от экспертов.";

// Пропсы для рекламного баннера
const adFreeProps = {
  id: "ad-free",
  title: "Забирай бесплатные курсы по подготовке к ЕГЭ по химии 2026",
  lead: "Два курса, которые дадут тебе +30 баллов на экзамене. Забирай по кнопкам ниже",
  ctaText: "Забрать оба курса",
  ctaHref:
    "https://t.me/chemistry_examBot?start=s=3272321-utm_source=cite-utm_content=main",
  image: {
    src: "/images/mainpage/adfree.png",
    width: 400,
    height: 300,
    alt: "Превью бесплатного курса",
  },
};

// Пропсы для лид-формы
const leadProps = {
  id: "lead-capture",
  imageSrc: "/images/girl-lead2.webp",
  imageAlt: "Ученица на уроке",
  title: "Начни подготовку с пробного бесплатного занятия",
  subtitle: "Ответим на вопросы, расскажем про форматы и цены",
  showSteps: true,
  stepsText: [
    "Познакомим с онлайн-школой",
    "Расскажем, как проходят занятия",
    "Запишем на бесплатный урок",
  ],
  formAction:
    "https://script.google.com/macros/s/AKfycbwBa6ffRK05gATFowu7yBpdmJ28C4EUEFJdxFrPbA_ZqRNizN1JK_b94Hb8SuJ9KxuE/exec",
  // UTM метки для страницы медиа
  utmSource: "media-page",
  utmMedium: "organic",
  utmCampaign: "media-lead",
};
---

<MainLayout
  title={pageTitle}
  description={pageDesc}
  url={`${site}/media/`}
  seoType="website"
  showBreadcrumbs={false}
>
  <SideCategoryScroller categories={categories} />

  <!-- Секция 1: home-grid -->
  {
    section1Main.length > 0 && (
      <section id="news">
        <div class="grid1__title container">
          <h2 class="grid1__title">
            <a
              href={`/media/category/${slugify("новости")}`}
              class="category-title-link"
            >
              Новости
            </a>
          </h2>
          <div class="grid__arrow">
            <img
              class="arrow"
              src="/images/mycollection/001-down-arrow.png"
              alt="Arrow"
              width="42"
              height="42"
            />
          </div>
        </div>
        <div class="home-grid container">
          {section1Main.map((post) => (
            <div class="ad-media__card">
              <CardNew post={post} basePath="/media" />
            </div>
          ))}
          {section1Horizontal.map((post) => (
            <div class="ad-media__card">
              <CardHorizontal post={post} basePath="/media" />
            </div>
          ))}
        </div>
      </section>
    )
  }

  <!-- Секция 2: home-grid-2 -->
  {
    section2Main.length > 0 && (
      <section id="school">
        <div class="grid1__title container">
          <h2 class="grid1__title">
            <a
              href={`/media/category/${slugify("школьникам")}`}
              class="category-title-link"
            >
              Школьникам
            </a>
          </h2>
          <div class="grid__arrow">
            <img
              class="arrow"
              src="/images/mycollection/001-down-arrow.png"
              alt="Arrow"
              width="42"
              height="42"
            />
          </div>
        </div>
        <div class="home-grid-2 container">
          {section2Main.map((post) => (
            <div class="ad-media__card">
              <CardNew post={post} basePath="/media" />
            </div>
          ))}
          {section2Horizontal.map((post) => (
            <div class="ad-media__card">
              <CardHorizontal post={post} basePath="/media" />
            </div>
          ))}
        </div>
      </section>
    )
  }
  <!-- Рекламный баннер -->
  <AdFreeBanner {...adFreeProps} />
  <!-- Секция 3: home-grid-3 -->
  {
    section3Vertical.length > 0 && (
      <section id="parents">
        <div class="grid1__title container">
          <h2 class="grid1__title">
            <a
              href={`/media/category/${slugify("родителям")}`}
              class="category-title-link"
            >
              Родителям
            </a>
          </h2>
          <div class="grid__arrow">
            <img
              class="arrow"
              src="/images/mycollection/001-down-arrow.png"
              alt="Arrow"
              width="42"
              height="42"
            />
          </div>
        </div>
        <div class="home-grid-3 container">
          {section3Vertical.map((post) => (
            <div class="ad-media__card">
              <CardNew post={post} basePath="/media" />
            </div>
          ))}
          {section3Horizontal.map((post) => (
            <div class="ad-media__card">
              <CardHorizontal post={post} basePath="/media" />
            </div>
          ))}
        </div>
      </section>
    )
  }

  <!-- Секция 4: home-grid-4 -->
  {
    section4Vertical.length > 0 && (
      <section id="video">
        <div class="grid1__title container">
          <h2 class="grid1__title">
            <a
              href={`/media/category/${slugify("видео")}`}
              class="category-title-link"
            >
              Наши видео
            </a>
          </h2>
          <div class="grid__arrow">
            <img
              class="arrow"
              src="/images/mycollection/001-down-arrow.png"
              alt="Arrow"
              width="42"
              height="42"
            />
          </div>
        </div>
        <div class="home-grid-4 container">
          {section4Vertical.map((post) => (
            <div class="ad-media__card">
              <CardNew post={post} basePath="/media" />
            </div>
          ))}
        </div>
      </section>
    )
  }

  <!-- Секция 5: home-grid-5 -->
  {
    section5Vertical.length > 0 && (
      <section id="psych">
        <div class="grid1__title container">
          <h2 class="grid1__title">
            <a
              href={`/media/category/${slugify("психология")}`}
              class="category-title-link"
            >
              Психология
            </a>
          </h2>
          <div class="grid__arrow">
            <img
              class="arrow"
              src="/images/mycollection/001-down-arrow.png"
              alt="Arrow"
              width="42"
              height="42"
            />
          </div>
        </div>
        <div class="home-grid-5 container">
          {section5Vertical.map((post) => (
            <div class="ad-media__card">
              <CardNew post={post} basePath="/media" />
            </div>
          ))}
        </div>
      </section>
    )
  }

  <!-- Секция 6: Как быть взрослым -->
  {
    section6Vertical.length > 0 && (
      <section id="adults">
        <div class="grid1__title container">
          <h2 class="grid1__title">
            <a
              href={`/media/category/${slugify("как быть взрослым")}`}
              class="category-title-link"
            >
              Как быть взрослым
            </a>
          </h2>
          <div class="grid__arrow">
            <img
              class="arrow"
              src="/images/mycollection/001-down-arrow.png"
              alt="Arrow"
              width="42"
              height="42"
            />
          </div>
        </div>
        <div class="home-grid-5 container">
          {section6Vertical.map((post) => (
            <div class="ad-media__card">
              <CardNew post={post} basePath="/media" />
            </div>
          ))}
        </div>
      </section>
    )
  }

  <!-- Секция 7: Материалы по химии -->
  {
    section7Vertical.length > 0 && (
      <section id="chemistry">
        <div class="grid1__title container">
          <h2 class="grid1__title">
            <a
              href={`/media/category/${slugify("материалы по химии")}`}
              class="category-title-link"
            >
              Материалы по химии
            </a>
          </h2>
          <div class="grid__arrow">
            <img
              class="arrow"
              src="/images/mycollection/001-down-arrow.png"
              alt="Arrow"
              width="42"
              height="42"
            />
          </div>
        </div>
        <div class="home-grid-5 container">
          {section7Vertical.map((post) => (
            <div class="ad-media__card">
              <CardNew post={post} basePath="/media" />
            </div>
          ))}
        </div>
      </section>
    )
  }

  <!-- Секция 8: Материалы для ЕГЭ и ОГЭ по химии -->
  {
    section8Vertical.length > 0 && (
      <section id="ege-oge">
        <div class="grid1__title container">
          <h2 class="grid1__title">
            <a
              href={`/media/category/${slugify("материалы для егэ и огэ по химии")}`}
              class="category-title-link"
            >
              Материалы для ЕГЭ и ОГЭ по химии
            </a>
          </h2>
          <div class="grid__arrow">
            <img
              class="arrow"
              src="/images/mycollection/001-down-arrow.png"
              alt="Arrow"
              width="42"
              height="42"
            />
          </div>
        </div>
        <div class="home-grid-5 container">
          {section8Vertical.map((post) => (
            <div class="ad-media__card">
              <CardNew post={post} basePath="/media" />
            </div>
          ))}
        </div>
      </section>
    )
  }

  <!-- Форма лид-захвата -->
  <LeadCapture {...leadProps} />
</MainLayout>

<style>
  .grid1__title {
    display: flex;
    align-items: center;
    margin-bottom: 50px;
    gap: 30px;
  }
  .grid1__title h2 {
    font-weight: 700;
    margin: 0;
  }

  /* Стили для кликабельных заголовков категорий */
  .category-title-link {
    color: inherit;
    text-decoration: none;
    transition:
      color 0.2s ease,
      opacity 0.2s ease;
    display: inline-block;
    position: relative;
  }

  .category-title-link:hover {
    opacity: 0.7;
  }

  .category-title-link::after {
    content: "";
    position: absolute;
    bottom: -2px;
    left: 0;
    width: 0;
    height: 2px;
    background: currentColor;
    transition: width 0.3s ease;
  }

  .category-title-link:hover::after {
    width: 100%;
  }

  .arrow {
    transition: all 0.3s ease;
    transform: rotate(270deg);
  }
  .grid1__title:hover .arrow {
    transform: rotate(225deg);
  }
  :global(.home-grid) {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr 1fr;
    gap: 30px;
  }

  /* первая карточка тянется на 2 колонки */
  :global(.home-grid > *:nth-child(1)) {
    grid-row: 1 / span 4;
    grid-column: 2 / span 2;
  }
  @media (max-width: 1000px) {
    :global(.home-grid) {
      grid-template-columns: 1fr 1fr;
    }
    :global(.home-grid > *:nth-child(1)) {
      grid-row: 1 / span 3;
      grid-column: 1 / span 1;
    }
  }
  @media (max-width: 600px) {
    :global(.home-grid) {
      grid-template-columns: 1fr;
    }
    :global(.home-grid > *:nth-child(1)) {
      grid-row: 1 / span 1;
      grid-column: 1 / span 1;
    }
  }

  :global(.home-grid-2) {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 30px;
  }
  :global(.home-grid-2 > *:nth-child(1)) {
    grid-row: 1 / span 4;
    grid-column: 1 / span 2;
  }
  @media (max-width: 1000px) {
    :global(.home-grid-2) {
      grid-template-columns: 1fr 1fr;
    }
    :global(.home-grid-2 > *:nth-child(1)) {
      grid-row: 1 / span 3;
      grid-column: 1 / span 1;
    }
  }
  @media (max-width: 600px) {
    :global(.home-grid-2) {
      grid-template-columns: 1fr;
    }
    :global(.home-grid-2 > *:nth-child(1)) {
      grid-row: 1 / span 1;
      grid-column: 1 / span 1;
    }
  }

  :global(.home-grid-3) {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 30px;
  }
  :global(.home-grid-3 > :nth-child(1)) {
    grid-row: 1 / span 3;
    grid-column: 1 / span 1;
  }
  :global(.home-grid-3 > :nth-child(2)) {
    grid-row: 1 / span 3;
    grid-column: 2 / span 1;
  }

  @media (max-width: 1000px) {
    :global(.home-grid-3) {
      grid-template-columns: 1fr 1fr;
    }
    :global(.home-grid-3 > *:nth-child(1)) {
      grid-row: 1 / span 3;
      grid-column: 1 / span 1;
    }
    :global(.home-grid-3 > *:nth-child(2)) {
      grid-row: 1 / span 3;
      grid-column: 1 / span 1;
    }
  }
  @media (max-width: 600px) {
    :global(.home-grid-3) {
      grid-template-columns: 1fr;
    }
    :global(.home-grid-3 > *:nth-child(1)) {
      grid-row: 1 / span 1;
      grid-column: 1 / span 1;
    }
    :global(.home-grid-3 > *:nth-child(2)) {
      grid-row: 1 / span 1;
      grid-column: 1 / span 1;
    }
  }
  :global(.home-grid-4) {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr 1fr;
    gap: 30px;
    margin-bottom: 50px;
  }
  @media (max-width: 1000px) {
    :global(.home-grid-4) {
      grid-template-columns: 1fr 1fr;
    }
  }
  @media (max-width: 600px) {
    :global(.home-grid-4) {
      grid-template-columns: 1fr;
    }
  }

  :global(.home-grid-5) {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr 1fr;
    gap: 30px;
  }
  :global(.home-grid-5 > :nth-child(1)) {
    grid-row: 1 / span 1;
    grid-column: 1 / span 2;
  }
  :global(.home-grid-5 > :nth-child(2)) {
    grid-row: 1 / span 1;
    grid-column: 3 / span 2;
  }

  @media (max-width: 1000px) {
    :global(.home-grid-5) {
      grid-template-columns: 1fr 1fr;
    }
    :global(.home-grid-5 > *:nth-child(1)) {
      grid-row: 1 / span 3;
      grid-column: 1 / span 1;
    }
    :global(.home-grid-5 > *:nth-child(2)) {
      grid-row: 1 / span 3;
      grid-column: 1 / span 1;
    }
  }
  @media (max-width: 600px) {
    :global(.home-grid-5) {
      grid-template-columns: 1fr;
    }
    :global(.home-grid-5 > *:nth-child(1)) {
      grid-row: 1 / span 1;
      grid-column: 1 / span 1;
    }
    :global(.home-grid-5 > *:nth-child(2)) {
      grid-row: 1 / span 1;
      grid-column: 1 / span 1;
    }
    .ad-media__card {
      display: flex;
      align-items: flex-start;
    }
  }
</style>
