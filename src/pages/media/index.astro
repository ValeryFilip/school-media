---
// src/pages/media/index.astro
import MainLayout from "../../layouts/MainLayout.astro";
import config from "../../config.ts";
import { getCollection } from "astro:content";
import { getCategoryHex } from "../../lib/categoryColors.ts";
import { slugify } from "../../lib/slugify.ts";
import CardNew from "../../components/cards/cardNew.astro";
import CardHorizontal from "../../components/cards/CardHorizontal.astro";
import LeadCapture from "../../components/mainpage/LeadCapture.astro";
import AdFreeBanner from "../../components/mainpage/AdFreeBanner.astro";
import SideCategoryScroller from "../../components/SideCategoryScroller.astro";

// Получаем все статьи и сортируем по дате (от новых к старым)
const toDate = (v: any) => (v instanceof Date ? v : new Date(v));
const allPosts = (await getCollection("articles")).sort(
  (a, b) => toDate(b.data.date).getTime() - toDate(a.data.date).getTime()
);

// Функция для фильтрации по категории
const filterByCategory = (category: string) =>
  allPosts.filter(
    (p) =>
      String(p.data.category || "").toLowerCase() === category.toLowerCase()
  );

// Категории
const categories = [
  { id: "news", label: "Новости", slug: "новости" },
  { id: "school", label: "Школьникам", slug: "школьникам" },
  { id: "parents", label: "Родителям", slug: "родителям" },
  { id: "enrol", label: "Поступление", slug: "поступление" },
  { id: "psych", label: "Психология", slug: "психология" },
  { id: "adults", label: "Как быть взрослым", slug: "как быть взрослым" },
  { id: "chemistry", label: "Материалы по химии", slug: "материалы по химии" },
]
  .filter((cat) => filterByCategory(cat.slug).length > 0)
  .map((c) => ({ ...c, color: getCategoryHex(c.label) }));

// Секция 1: home-grid (1 CardNew + 8 CardHorizontal)
const section1Posts = filterByCategory("новости");
const section1Main = section1Posts.slice(0, 1);
const section1Horizontal = section1Posts.slice(1, 8);

// Секция 2: home-grid-2 (1 CardNew + 8 CardHorizontal)
const section2Posts = filterByCategory("школьникам");
const section2Main = section2Posts.slice(0, 1);
const section2Horizontal = section2Posts.slice(1, 8);

// Секция 3: home-grid-3 (2 CardNew + 6 CardHorizontal)
const section3Posts = filterByCategory("родителям");
const section3Vertical = section3Posts.slice(0, 2);
const section3Horizontal = section3Posts.slice(2, 8);

// Секция 4: home-grid-4 (6 CardNew)
const section4Posts = filterByCategory("поступление");
const section4Vertical = section4Posts.slice(0, 8);

// Секция 5: home-grid-5 (2 CardNew + остальные CardNew)
const section5Posts = filterByCategory("психология");
const section5Vertical = section5Posts.slice(0, 6);

// Секция 6: Как быть взрослым (6 CardNew)
const section6Posts = filterByCategory("как быть взрослым");
const section6Vertical = section6Posts.slice(0, 6);

// Секция 7: Материалы по химии (6 CardNew)
const section7Posts = filterByCategory("материалы по химии");
const section7Vertical = section7Posts.slice(0, 6);

// SEO
const site = config.siteUrl.replace(/\/$/, "");
const pageTitle = "Главная — ЕГЭХИМ";
const pageDesc =
  "Главный экран с подборками статей по химии, подготовке к ЕГЭ и ОГЭ.";

// Пропсы для рекламного баннера
const adFreeProps = {
  id: "ad-free",
  title: "Забирай бесплатные курсы по подготовке к ЕГЭ по химии 2026",
  lead: "Два курса, которые дадут тебе +30 баллов на экзамене. Забирай по кнопкам ниже",
  ctaText: "Забрать оба курса",
  image: {
    src: "/images/mainpage/adfree.png",
    width: 400,
    height: 300,
    alt: "Превью бесплатного курса",
  },
};
---

<MainLayout
  title={pageTitle}
  description={pageDesc}
  url={`${site}/media/`}
  seoType="website"
  showBreadcrumbs={false}
>
  <SideCategoryScroller categories={categories} />

  <!-- Секция 1: home-grid -->
  {
    section1Main.length > 0 && (
      <section id="news">
        <div class="grid1__title container">
          <h2 class="grid1__title">
            <a
              href={`/media/category/${slugify("новости")}`}
              class="category-title-link"
            >
              Новости
            </a>
          </h2>
          <div class="grid__arrow">
            <img
              class="arrow"
              src="/images/mycollection/001-down-arrow.png"
              alt="Arrow"
              width="42"
              height="42"
            />
          </div>
        </div>
        <div class="home-grid container">
          {section1Main.map((post) => (
            <CardNew post={post} basePath="/media" />
          ))}
          {section1Horizontal.map((post) => (
            <CardHorizontal post={post} basePath="/media" />
          ))}
        </div>
        <div class="container">
          <a
            href={`/media/category/${slugify("новости")}`}
            class="category-button"
            style={`background-color: ${getCategoryHex("новости")};`}
          >
            Посмотреть все
          </a>
        </div>
      </section>
    )
  }

  <!-- Секция 2: home-grid-2 -->
  {
    section2Main.length > 0 && (
      <section id="school">
        <div class="grid1__title container">
          <h2 class="grid1__title">
            <a
              href={`/media/category/${slugify("школьникам")}`}
              class="category-title-link"
            >
              Школьникам
            </a>
          </h2>
          <div class="grid__arrow">
            <img
              class="arrow"
              src="/images/mycollection/001-down-arrow.png"
              alt="Arrow"
              width="42"
              height="42"
            />
          </div>
        </div>
        <div class="home-grid-2 container">
          {section2Main.map((post) => (
            <CardNew post={post} basePath="/media" />
          ))}
          {section2Horizontal.map((post) => (
            <CardHorizontal post={post} basePath="/media" />
          ))}
        </div>
        <div class="container">
          <a
            href={`/media/category/${slugify("школьникам")}`}
            class="category-button"
            style={`background-color: ${getCategoryHex("школьникам")};`}
          >
            Посмотреть все
          </a>
        </div>
      </section>
    )
  }
  <!-- Рекламный баннер -->
  <AdFreeBanner {...adFreeProps} />
  <!-- Секция 3: home-grid-3 -->
  {
    section3Vertical.length > 0 && (
      <section id="parents">
        <div class="grid1__title container">
          <h2 class="grid1__title">
            <a
              href={`/media/category/${slugify("родителям")}`}
              class="category-title-link"
            >
              Родителям
            </a>
          </h2>
          <div class="grid__arrow">
            <img
              class="arrow"
              src="/images/mycollection/001-down-arrow.png"
              alt="Arrow"
              width="42"
              height="42"
            />
          </div>
        </div>
        <div class="home-grid-3 container">
          {section3Vertical.map((post) => (
            <CardNew post={post} basePath="/media" />
          ))}
          {section3Horizontal.map((post) => (
            <CardHorizontal post={post} basePath="/media" />
          ))}
        </div>
        <div class="container">
          <a
            href={`/media/category/${slugify("родителям")}`}
            class="category-button"
            style={`background-color: ${getCategoryHex("родителям")};`}
          >
            Посмотреть все
          </a>
        </div>
      </section>
    )
  }

  <!-- Секция 4: home-grid-4 -->
  {
    section4Vertical.length > 0 && (
      <section id="enrol">
        <div class="grid1__title container">
          <h2 class="grid1__title">
            <a
              href={`/media/category/${slugify("поступление")}`}
              class="category-title-link"
            >
              Поступление
            </a>
          </h2>
          <div class="grid__arrow">
            <img
              class="arrow"
              src="/images/mycollection/001-down-arrow.png"
              alt="Arrow"
              width="42"
              height="42"
            />
          </div>
        </div>
        <div class="home-grid-4 container">
          {section4Vertical.map((post) => (
            <CardNew post={post} basePath="/media" />
          ))}
        </div>
        <div class="container">
          <a
            href={`/media/category/${slugify("поступление")}`}
            class="category-button"
            style={`background-color: ${getCategoryHex("поступление")};`}
          >
            Посмотреть все
          </a>
        </div>
      </section>
    )
  }

  <!-- Секция 5: home-grid-5 -->
  {
    section5Vertical.length > 0 && (
      <section id="psych">
        <div class="grid1__title container">
          <h2 class="grid1__title">
            <a
              href={`/media/category/${slugify("психология")}`}
              class="category-title-link"
            >
              Психология
            </a>
          </h2>
          <div class="grid__arrow">
            <img
              class="arrow"
              src="/images/mycollection/001-down-arrow.png"
              alt="Arrow"
              width="42"
              height="42"
            />
          </div>
        </div>
        <div class="home-grid-5 container">
          {section5Vertical.map((post) => (
            <CardNew post={post} basePath="/media" />
          ))}
        </div>
        <div class="container">
          <a
            href={`/media/category/${slugify("психология")}`}
            class="category-button"
            style={`background-color: ${getCategoryHex("психология")};`}
          >
            Посмотреть все
          </a>
        </div>
      </section>
    )
  }

  <!-- Секция 6: Как быть взрослым -->
  {
    section6Vertical.length > 0 && (
      <section id="adults">
        <div class="grid1__title container">
          <h2 class="grid1__title">
            <a
              href={`/media/category/${slugify("как быть взрослым")}`}
              class="category-title-link"
            >
              Как быть взрослым
            </a>
          </h2>
          <div class="grid__arrow">
            <img
              class="arrow"
              src="/images/mycollection/001-down-arrow.png"
              alt="Arrow"
              width="42"
              height="42"
            />
          </div>
        </div>
        <div class="home-grid-5 container">
          {section6Vertical.map((post) => (
            <CardNew post={post} basePath="/media" />
          ))}
        </div>
        <div class="container">
          <a
            href={`/media/category/${slugify("как быть взрослым")}`}
            class="category-button"
            style={`background-color: ${getCategoryHex("как быть взрослым")};`}
          >
            Посмотреть все
          </a>
        </div>
      </section>
    )
  }

  <!-- Секция 7: Материалы по химии -->
  {
    section7Vertical.length > 0 && (
      <section id="chemistry">
        <div class="grid1__title container">
          <h2 class="grid1__title">
            <a
              href={`/media/category/${slugify("материалы по химии")}`}
              class="category-title-link"
            >
              Материалы по химии
            </a>
          </h2>
          <div class="grid__arrow">
            <img
              class="arrow"
              src="/images/mycollection/001-down-arrow.png"
              alt="Arrow"
              width="42"
              height="42"
            />
          </div>
        </div>
        <div class="home-grid-5 container">
          {section7Vertical.map((post) => (
            <CardNew post={post} basePath="/media" />
          ))}
        </div>
        <div class="container">
          <a
            href={`/media/category/${slugify("материалы по химии")}`}
            class="category-button"
            style={`background-color: ${getCategoryHex("материалы по химии")};`}
          >
            Посмотреть все
          </a>
        </div>
      </section>
    )
  }

  <!-- Форма лид-захвата -->
  <LeadCapture
    id="lead-capture-form"
    title="Запишись на бесплатную консультацию по подготовке к ЕГЭ"
    subtitle="Узнай, как эффективно подготовиться к экзамену и получить высокий балл"
    image={{
      src: "/images/girl-lead.webp",
      alt: "Студентка с книгами",
      width: 400,
      height: 500,
    }}
  />
</MainLayout>

<style>
  .grid1__title {
    display: flex;
    align-items: center;
    margin-bottom: 50px;
    gap: 30px;
  }
  .grid1__title h2 {
    font-weight: 700;
    margin: 0;
  }

  /* Стили для кликабельных заголовков категорий */
  .category-title-link {
    color: inherit;
    text-decoration: none;
    transition:
      color 0.2s ease,
      opacity 0.2s ease;
    display: inline-block;
    position: relative;
  }

  .category-title-link:hover {
    opacity: 0.7;
  }

  .category-title-link::after {
    content: "";
    position: absolute;
    bottom: -2px;
    left: 0;
    width: 0;
    height: 2px;
    background: currentColor;
    transition: width 0.3s ease;
  }

  .category-title-link:hover::after {
    width: 100%;
  }

  .arrow {
    transition: all 0.3s ease;
    transform: rotate(270deg);
  }
  .grid1__title:hover .arrow {
    transform: rotate(225deg);
  }
  :global(.home-grid) {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr 1fr;
    gap: 30px;
  }

  /* первая карточка тянется на 2 колонки */
  :global(.home-grid > *:nth-child(1)) {
    grid-row: 1 / span 4;
    grid-column: 2 / span 2;
  }
  @media (max-width: 1000px) {
    :global(.home-grid) {
      grid-template-columns: 1fr 1fr;
    }
    :global(.home-grid > *:nth-child(1)) {
      grid-row: 1 / span 3;
      grid-column: 1 / span 1;
    }
  }
  @media (max-width: 600px) {
    :global(.home-grid) {
      grid-template-columns: 1fr;
    }
    :global(.home-grid > *:nth-child(1)) {
      grid-row: 1 / span 1;
      grid-column: 1 / span 1;
    }
  }

  :global(.home-grid-2) {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 30px;
  }
  :global(.home-grid-2 > *:nth-child(1)) {
    grid-row: 1 / span 4;
    grid-column: 1 / span 2;
  }
  @media (max-width: 1000px) {
    :global(.home-grid-2) {
      grid-template-columns: 1fr 1fr;
    }
    :global(.home-grid-2 > *:nth-child(1)) {
      grid-row: 1 / span 3;
      grid-column: 1 / span 1;
    }
  }
  @media (max-width: 600px) {
    :global(.home-grid-2) {
      grid-template-columns: 1fr;
    }
    :global(.home-grid-2 > *:nth-child(1)) {
      grid-row: 1 / span 1;
      grid-column: 1 / span 1;
    }
  }

  :global(.home-grid-3) {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 30px;
  }
  :global(.home-grid-3 > :nth-child(1)) {
    grid-row: 1 / span 3;
    grid-column: 1 / span 1;
  }
  :global(.home-grid-3 > :nth-child(2)) {
    grid-row: 1 / span 3;
    grid-column: 2 / span 1;
  }

  @media (max-width: 1000px) {
    :global(.home-grid-3) {
      grid-template-columns: 1fr 1fr;
    }
    :global(.home-grid-3 > *:nth-child(1)) {
      grid-row: 1 / span 3;
      grid-column: 1 / span 1;
    }
    :global(.home-grid-3 > *:nth-child(2)) {
      grid-row: 1 / span 3;
      grid-column: 1 / span 1;
    }
  }
  @media (max-width: 600px) {
    :global(.home-grid-3) {
      grid-template-columns: 1fr;
    }
    :global(.home-grid-3 > *:nth-child(1)) {
      grid-row: 1 / span 1;
      grid-column: 1 / span 1;
    }
    :global(.home-grid-3 > *:nth-child(2)) {
      grid-row: 1 / span 1;
      grid-column: 1 / span 1;
    }
  }
  :global(.home-grid-4) {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr 1fr;
    gap: 30px;
    margin-bottom: 50px;
  }
  .category-button {
    display: block;
    width: 100%;
    padding: 14px 24px;
    font-size: 16px;
    font-weight: 600;
    color: #fff;
    text-align: center;
    text-decoration: none;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition:
      opacity 0.2s ease,
      transform 0.15s ease;
    margin-top: 30px;
  }
  .category-button:hover {
    opacity: 0.85;
    transform: translateY(-2px);
  }
  .category-button:active {
    transform: translateY(0);
  }
  @media (max-width: 1000px) {
    :global(.home-grid-4) {
      grid-template-columns: 1fr 1fr;
    }
  }
  @media (max-width: 600px) {
    :global(.home-grid-4) {
      grid-template-columns: 1fr;
    }
  }

  :global(.home-grid-5) {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr 1fr;
    gap: 30px;
  }
  :global(.home-grid-5 > :nth-child(1)) {
    grid-row: 1 / span 1;
    grid-column: 1 / span 2;
  }
  :global(.home-grid-5 > :nth-child(2)) {
    grid-row: 1 / span 1;
    grid-column: 3 / span 2;
  }

  @media (max-width: 1000px) {
    :global(.home-grid-5) {
      grid-template-columns: 1fr 1fr;
    }
    :global(.home-grid-5 > *:nth-child(1)) {
      grid-row: 1 / span 3;
      grid-column: 1 / span 1;
    }
    :global(.home-grid-5 > *:nth-child(2)) {
      grid-row: 1 / span 3;
      grid-column: 1 / span 1;
    }
  }
  @media (max-width: 600px) {
    :global(.home-grid-5) {
      grid-template-columns: 1fr;
    }
    :global(.home-grid-5 > *:nth-child(1)) {
      grid-row: 1 / span 1;
      grid-column: 1 / span 1;
    }
    :global(.home-grid-5 > *:nth-child(2)) {
      grid-row: 1 / span 1;
      grid-column: 1 / span 1;
    }
  }
</style>
