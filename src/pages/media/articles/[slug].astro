---
// src/pages/articles/[slug].astro
import MainLayout from "../../../layouts/MainLayout.astro";
import ArticleLayoutNew from "../../../layouts/ArticleLayoutNew.astro";
import config from "../../../config.ts";
import { getCollection, getEntryBySlug } from "astro:content";
import { slugify } from "../../../lib/slugify";

export async function getStaticPaths() {
  const posts = await getCollection("articles", ({ data }) => {
    return data.visible !== false; // только видимые статьи (по умолчанию true)
  });
  return posts.map((post) => ({ params: { slug: post.slug } }));
}

const { slug } = Astro.params;

const entry = await getEntryBySlug("articles", slug);
if (!entry) throw new Error(`Статья "${slug}" не найдена`);

// Проверка видимости статьи
if (entry.data.visible === false) {
  return Astro.redirect("/404");
}

const { data: fm, render } = entry;
const { Content, headings } = await render();

// Рекомендации (только видимые статьи)
const all = await getCollection("articles", ({ data }) => {
  return data.visible !== false;
});
const byTag = all.filter(
  (p) => p.slug !== slug && p.data.tags?.some((t) => fm.tags?.includes(t))
);
const byCategory = all.filter(
  (p) =>
    p.slug !== slug && p.data.category === fm.category && !byTag.includes(p)
);
const recommendations = [...byTag, ...byCategory].slice(0, 4);

// Полный URL (⚙️ через /media/)
const siteUrl = config.siteUrl.replace(/\/$/, "");
const pageUrl = `${siteUrl}/media/articles/${slug}/`;

// Хлебные крошки (категория тоже через /media/)
const breadcrumbs = [
  {
    name: `${fm.category}`,
    href: `${siteUrl}/media/category/${slugify(fm.category)}/`,
  },
  { name: fm.title }, // текущая страница — без href
];
---

<MainLayout
  title={fm.title}
  description={fm.description}
  image={fm.image}
  url={pageUrl}
  seoType="article"
  datePublished={new Date(fm.date as any).toISOString()}
  dateModified={(fm as any).updated
    ? new Date((fm as any).updated as any).toISOString()
    : new Date(fm.date as any).toISOString()}
  breadcrumbs={breadcrumbs}
>
  <ArticleLayoutNew fm={fm} slug={slug} headings={headings}>
    <Content />
  </ArticleLayoutNew>
</MainLayout>
