---
// src/pages/articles/[slug].astro
import MainLayout from "../../../layouts/MainLayout.astro";
import ArticleLayoutNew from "../../../layouts/ArticleLayoutNew.astro";
import config from "../../../config.ts";
import { getCollection, getEntryBySlug } from "astro:content";
import { slugify } from "../../../lib/slugify";
import { calcReadingTime } from "../../../lib/calcReadingTime";
import { buildArticleJsonLd } from "../../../lib/seoData";

export async function getStaticPaths() {
  const posts = await getCollection("articles", ({ data }) => {
    return data.visible !== false; // только видимые статьи (по умолчанию true)
  });
  return posts.map((post) => ({ params: { slug: post.slug } }));
}

const { slug } = Astro.params;

const entry = await getEntryBySlug("articles", slug);
if (!entry) throw new Error(`Статья "${slug}" не найдена`);

// Проверка видимости статьи
if (entry.data.visible === false) {
  return Astro.redirect("/404");
}

const fm = {
  ...entry.data,
  readingTime: calcReadingTime(entry.body),
  tocManual: entry.data.tocManual
    ? entry.data.tocManual.map((item) => ({
        id: item.id || slugify(item.text),
        text: item.text,
      }))
    : undefined,
};

const { Content, headings } = await entry.render();

// Рекомендации (только видимые статьи)
const all = await getCollection("articles", ({ data }) => {
  return data.visible !== false;
});
const byTag = all.filter(
  (p) => p.slug !== slug && p.data.tags?.some((t) => fm.tags?.includes(t))
);
const byCategory = all.filter(
  (p) =>
    p.slug !== slug && p.data.category === fm.category && !byTag.includes(p)
);
const recommendations = [...byTag, ...byCategory].slice(0, 4);

// Полный URL (⚙️ через /media/)
const siteUrl = config.siteUrl.replace(/\/$/, "");
const pageUrl = `${siteUrl}/media/articles/${slug}/`;

// Хлебные крошки (категория тоже через /media/)
const breadcrumbs = [
  {
    name: `${fm.category}`,
    href: `${siteUrl}/media/category/${slugify(fm.category)}/`,
  },
  { name: fm.title }, // текущая страница — без href
];

// Article JSON-LD для статей (keywords, articleSection)
const articleJsonLd = buildArticleJsonLd({
  origin: siteUrl,
  url: pageUrl,
  headline: fm.title,
  description: fm.description,
  image: fm.image,
  datePublished: new Date(fm.date as any).toISOString(),
  dateModified: (fm as any).updated
    ? new Date((fm as any).updated as any).toISOString()
    : new Date(fm.date as any).toISOString(),
  keywords: fm.tags?.length ? fm.tags : undefined,
  articleSection: fm.category,
});
---

<MainLayout
  title={fm.title}
  description={fm.description}
  image={fm.image}
  url={pageUrl}
  seoType="article"
  datePublished={new Date(fm.date as any).toISOString()}
  dateModified={(fm as any).updated
    ? new Date((fm as any).updated as any).toISOString()
    : new Date(fm.date as any).toISOString()}
  breadcrumbs={breadcrumbs}
  articleJsonLd={articleJsonLd}
>
  <ArticleLayoutNew fm={fm} slug={slug} headings={headings}>
    <Content />
  </ArticleLayoutNew>
</MainLayout>
